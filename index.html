<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1f66d1" />
  <title>MKB æ˜¥æ—¥äº•ï½œå‹¤å‹™ç¢ºèª</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ä¸Šéƒ¨ãƒãƒ¼ï¼ˆä¸‹ã®é‡è¤‡ã¯ä½œã‚Šã¾ã›ã‚“ï¼‰ -->
  <header class="topbar">
    <div class="brand">MKB æ˜¥æ—¥äº•</div>
    <button class="adminBtn" id="openAdminBtn" type="button">ç®¡ç†è€…</button>
  </header>

  <!-- ç”»é¢1ï¼šãƒ›ãƒ¼ãƒ  -->
  <main class="screen active" id="screenHome" aria-label="ãƒ›ãƒ¼ãƒ ">
    <h1 class="title">å‹¤å‹™ç¢ºèª</h1>

    <button class="goBtn" id="goBtn" type="button" aria-label="GO">GO</button>

    <div class="deadlineWrap" aria-label="ç· åˆ‡">
      <div class="deadlineText" id="deadlineText">ç· åˆ‡ï¼š17:00</div>
    </div>
  </main>

  <!-- ç”»é¢2ï¼šåå‰å…¥åŠ› -->
  <main class="screen" id="screenName" aria-label="åå‰å…¥åŠ›">
    <div class="card">
      <div class="cardTitle">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      <div class="hint">ä¾‹ï¼šä½è—¤ å¤ªéƒ</div>

      <input class="textInput" id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="ãŠåå‰" />

      <button class="primaryBtn" id="nameConfirmBtn" type="button">ç¢ºèª</button>

      <button class="linkBtn" id="backToHomeFromName" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç”»é¢3ï¼šç‚¹å‘¼ç°¿ï¼ˆPDFç¢ºèªï¼‰ -->
  <main class="screen" id="screenPdf" aria-label="ç‚¹å‘¼ç°¿">
    <div class="dateRow">
      <span class="badgeNew" id="badgeNew">æœ€æ–°</span>
      <span class="dateText" id="todayText">2026å¹´1æœˆ1æ—¥</span>
    </div>

    <div class="pdfTitle">ç‚¹å‘¼ç°¿</div>

    <!-- PDFè¡¨ç¤ºæ ï¼ˆãƒªãƒ³ã‚¯ã§é–‹ãæ–¹å¼ï¼šiPhone/Androidä¸¡å¯¾å¿œï¼‰ -->
    <div class="pdfBox">
      <div class="pdfIcon">PDF</div>
      <div class="pdfFile" id="pdfFileName">ç‚¹å‘¼ç°¿PDF</div>
      <a class="openBtn" id="openPdfLink" href="#" target="_blank" rel="noopener">é–‹ã</a>
    </div>

    <div class="checkRow">
      <label class="checkLabel">
        <input type="checkbox" id="agreeCheck" />
        <span>ç¢ºèªã—ã¾ã—ãŸï¼ˆç· åˆ‡ã¾ã§ï¼‰</span>
      </label>
    </div>

    <button class="primaryBtn" id="doneBtn" type="button">ç¢ºèªã—ã¾ã—ãŸ</button>

    <!-- æ³¨æ„æ›¸ãï¼šé»’ãƒ»å¤ªå­—ãƒ»å°ã•ã‚ï¼ˆå ´æ‰€ã¯ä¸‹ï¼‰ -->
    <div class="notice">
      â€»å›£ä½“åãƒ»å€‹äººæƒ…å ±ã‚’å«ã‚€ãŸã‚è»¢ç”¨ç¦æ­¢
    </div>

    <button class="linkBtn" id="backToHomeFromPdf" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ç”»é¢4ï¼šç· åˆ‡å¾Œ -->
  <main class="screen" id="screenClosed" aria-label="ç· åˆ‡å¾Œ">
    <div class="closedDate" id="closedDate">2026-01-01</div>
    <div class="closedTitle">ãƒãƒƒãƒˆç¢ºèªã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</div>
    <div class="closedSub">é›»è©±ã«ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
    <div class="phoneIcon">ğŸ“</div>
    <button class="linkBtn" id="backToHomeFromClosed" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ç®¡ç†è€…ï¼šPIN -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalSheet">
      <div class="modalTitle">ç®¡ç†è€…</div>

      <div class="modalHint">æš—è¨¼ç•ªå·ï¼ˆ4æ¡ï¼‰</div>
      <input class="pinInput" id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" />

      <button class="primaryBtn" id="pinEnterBtn" type="button">é–‹ã</button>
      <button class="linkBtn" id="closeAdminModal" type="button">é–‰ã˜ã‚‹</button>

      <div class="errorText" id="pinError" style="display:none;">æš—è¨¼ç•ªå·ãŒé•ã„ã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- ç®¡ç†è€…ç”»é¢ -->
  <main class="screen" id="screenAdmin" aria-label="ç®¡ç†è€…ç”»é¢">
    <h2 class="adminTitle">ç®¡ç†è€…ç”»é¢</h2>

    <div class="adminCard">
      <div class="adminSectionTitle">ç· åˆ‡æ™‚é–“</div>
      <div class="row">
        <input class="timeInput" id="deadlineInput" type="time" />
        <button class="smallBtn" id="saveDeadlineBtn" type="button">ä¿å­˜</button>
      </div>
      <div class="adminNote">â€»ä¿å­˜ã™ã‚‹ã¨ã€åˆæœŸç”»é¢ã®ç· åˆ‡è¡¨ç¤ºã¨ç· åˆ‡åˆ¤å®šã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">ç‚¹å‘¼ç°¿PDFãƒªãƒ³ã‚¯</div>
      <input class="textInput" id="pdfUrlInput" type="url" placeholder="PDFã®URLã‚’è²¼ã‚Šä»˜ã‘" />
      <button class="smallBtn wide" id="savePdfBtn" type="button">ä¿å­˜</button>
      <div class="adminNote">â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…±æœ‰ãƒªãƒ³ã‚¯ç­‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">ç™»éŒ²è€…ï¼ˆåå‰ï¼‰</div>
      <div class="row">
        <input class="textInput" id="addUserInput" type="text" placeholder="è¿½åŠ ã™ã‚‹åå‰" />
        <button class="smallBtn" id="addUserBtn" type="button">è¿½åŠ </button>
      </div>

      <div class="adminList" id="userList"></div>
      <div class="adminNote">â€»é€€è·è€…ã¯ã“ã“ã§å‰Šé™¤ã™ã‚Œã°ã€URLã‚’é–‹ã„ã¦ã‚‚ç¢ºèªã§ãã¾ã›ã‚“ã€‚</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">æœ¬æ—¥ã®ç¢ºèªè€…</div>
      <div class="adminList" id="confirmedList"></div>
      <div class="adminNote">â€»æ—¥ä»˜ã”ã¨ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰ã€‚</div>
    </div>

    <button class="linkBtn" id="exitAdminBtn" type="button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
  </main>

  <script>
    // ====== è¨­å®š ======
    const ADMIN_PIN = "0900";
    const LS_KEYS = {
      deadline: "mkb_deadline",     // "HH:MM"
      pdfUrl: "mkb_pdf_url",        // string
      users: "mkb_users",           // JSON array
      confirmed: "mkb_confirmed"    // JSON { "YYYY-MM-DD": [names...] }
    };

    // ====== è¦ç´  ======
    const screens = {
      home: document.getElementById("screenHome"),
      name: document.getElementById("screenName"),
      pdf: document.getElementById("screenPdf"),
      closed: document.getElementById("screenClosed"),
      admin: document.getElementById("screenAdmin"),
    };

    const deadlineText = document.getElementById("deadlineText");

    const goBtn = document.getElementById("goBtn");
    const nameInput = document.getElementById("nameInput");
    const nameConfirmBtn = document.getElementById("nameConfirmBtn");

    const openPdfLink = document.getElementById("openPdfLink");
    const pdfFileName = document.getElementById("pdfFileName");
    const todayText = document.getElementById("todayText");
    const badgeNew = document.getElementById("badgeNew");

    const agreeCheck = document.getElementById("agreeCheck");
    const doneBtn = document.getElementById("doneBtn");

    const closedDate = document.getElementById("closedDate");

    // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ«
    const adminModal = document.getElementById("adminModal");
    const openAdminBtn = document.getElementById("openAdminBtn");
    const closeAdminModal = document.getElementById("closeAdminModal");
    const pinInput = document.getElementById("pinInput");
    const pinEnterBtn = document.getElementById("pinEnterBtn");
    const pinError = document.getElementById("pinError");

    // ç®¡ç†è€…ç”»é¢
    const deadlineInput = document.getElementById("deadlineInput");
    const saveDeadlineBtn = document.getElementById("saveDeadlineBtn");

    const pdfUrlInput = document.getElementById("pdfUrlInput");
    const savePdfBtn = document.getElementById("savePdfBtn");

    const addUserInput = document.getElementById("addUserInput");
    const addUserBtn = document.getElementById("addUserBtn");
    const userList = document.getElementById("userList");
    const confirmedList = document.getElementById("confirmedList");

    const exitAdminBtn = document.getElementById("exitAdminBtn");

    // æˆ»ã‚‹
    document.getElementById("backToHomeFromName").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromPdf").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromClosed").onclick = () => showScreen("home");

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function pad(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function todayJP(){
      const d = new Date();
      return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    }
    function nowHHMM(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function getDeadline(){
      return localStorage.getItem(LS_KEYS.deadline) || "17:00";
    }
    function setDeadline(v){
      localStorage.setItem(LS_KEYS.deadline, v);
    }
    function isAfterDeadline(){
      // HH:MM æ–‡å­—åˆ—æ¯”è¼ƒã§OKï¼ˆã‚¼ãƒ­åŸ‹ã‚å‰æï¼‰
      return nowHHMM() > getDeadline();
    }
    function getUsers(){
      try {
        return JSON.parse(localStorage.getItem(LS_KEYS.users) || "[]");
      } catch {
        return [];
      }
    }
    function setUsers(arr){
      localStorage.setItem(LS_KEYS.users, JSON.stringify(arr));
    }
    function getConfirmedAll(){
      try {
        return JSON.parse(localStorage.getItem(LS_KEYS.confirmed) || "{}");
      } catch {
        return {};
      }
    }
    function setConfirmedAll(obj){
      localStorage.setItem(LS_KEYS.confirmed, JSON.stringify(obj));
    }
    function addConfirmed(name){
      const iso = todayISO();
      const all = getConfirmedAll();
      all[iso] = all[iso] || [];
      if (!all[iso].includes(name)) all[iso].push(name);
      setConfirmedAll(all);
    }
    function getPdfUrl(){
      return localStorage.getItem(LS_KEYS.pdfUrl) || "#";
    }
    function setPdfUrl(url){
      localStorage.setItem(LS_KEYS.pdfUrl, url);
    }

    function showScreen(key){
      Object.values(screens).forEach(el => el.classList.remove("active"));
      screens[key].classList.add("active");
      window.scrollTo({top:0, behavior:"instant"});
    }

    // ====== åˆæœŸè¡¨ç¤ºåæ˜  ======
    function refreshHome(){
      deadlineText.textContent = `ç· åˆ‡ï¼š${getDeadline()}`;
    }

    function refreshPdf(){
      todayText.textContent = todayJP();
      badgeNew.style.display = "inline-block";

      const url = getPdfUrl();
      openPdfLink.href = url === "#" ? "#" : url;
      openPdfLink.classList.toggle("disabled", url === "#");
      pdfFileName.textContent = url === "#" ? "PDFæœªè¨­å®šï¼ˆç®¡ç†è€…ã§è¨­å®šã—ã¦ãã ã•ã„ï¼‰" : "ç‚¹å‘¼ç°¿PDF";

      agreeCheck.checked = false;
      doneBtn.disabled = true;
      doneBtn.classList.add("disabled");
    }

    // ====== GOæŠ¼ä¸‹ ======
    goBtn.addEventListener("click", () => {
      refreshHome();
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      showScreen("name");
      setTimeout(()=>nameInput.focus(), 50);
    });

    // åå‰ç¢ºèª
    nameConfirmBtn.addEventListener("click", () => {
      const name = (nameInput.value || "").trim();
      if (!name){
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ç™»éŒ²è€…åˆ¶å¾¡ï¼ˆé€€è·è€…å¯¾ç­–ï¼‰
      const users = getUsers();
      if (users.length > 0 && !users.includes(name)){
        alert("ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      // ç· åˆ‡ãƒã‚§ãƒƒã‚¯
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }

      // ä¸€æ™‚ä¿å­˜
      sessionStorage.setItem("mkb_current_name", name);

      refreshPdf();
      showScreen("pdf");
    });

    // PDFç”»é¢ã®ãƒã‚§ãƒƒã‚¯
    agreeCheck.addEventListener("change", () => {
      const ok = agreeCheck.checked && !isAfterDeadline();
      doneBtn.disabled = !ok;
      doneBtn.classList.toggle("disabled", !ok);
    });

    // ç¢ºèªã—ã¾ã—ãŸ
    doneBtn.addEventListener("click", () => {
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      const name = sessionStorage.getItem("mkb_current_name") || "";
      if (!name){
        showScreen("home");
        return;
      }
      addConfirmed(name);
      alert("ç¢ºèªã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚");
      showScreen("home");
      nameInput.value = "";
      sessionStorage.removeItem("mkb_current_name");
    });

    // ====== ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ« ======
    openAdminBtn.addEventListener("click", () => {
      pinInput.value = "";
      pinError.style.display = "none";
      adminModal.classList.add("show");
      adminModal.setAttribute("aria-hidden","false");
      setTimeout(()=>pinInput.focus(), 50);
    });

    closeAdminModal.addEventListener("click", () => {
      adminModal.classList.remove("show");
      adminModal.setAttribute("aria-hidden","true");
    });

    pinEnterBtn.addEventListener("click", () => {
      const pin = (pinInput.value || "").trim();
      if (pin === ADMIN_PIN){
        adminModal.classList.remove("show");
        adminModal.setAttribute("aria-hidden","true");
        openAdmin();
      } else {
        pinError.style.display = "block";
      }
    });

    // ====== ç®¡ç†è€…ç”»é¢ ======
    function openAdmin(){
      // å…¥åŠ›åæ˜ 
      deadlineInput.value = getDeadline();
      pdfUrlInput.value = (getPdfUrl() === "#") ? "" : getPdfUrl();

      renderUsers();
      renderConfirmed();

      showScreen("admin");
    }

    function renderUsers(){
      const users = getUsers();
      if (users.length === 0){
        userList.innerHTML = `<div class="empty">ï¼ˆç™»éŒ²è€…ãªã—ï¼‰</div>`;
        return;
      }
      userList.innerHTML = users.map(u => `
        <div class="listRow">
          <div class="listName">${escapeHtml(u)}</div>
          <button class="delBtn" data-name="${encodeURIComponent(u)}" type="button">å‰Šé™¤</button>
        </div>
      `).join("");

      userList.querySelectorAll(".delBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = decodeURIComponent(btn.dataset.name || "");
          const next = getUsers().filter(x => x !== name);
          setUsers(next);
          renderUsers();
        });
      });
    }

    function renderConfirmed(){
      const iso = todayISO();
      const all = getConfirmedAll();
      const list = all[iso] || [];
      if (list.length === 0){
        confirmedList.innerHTML = `<div class="empty">ï¼ˆæœ¬æ—¥ã®ç¢ºèªè€…ãªã—ï¼‰</div>`;
        return;
      }
      confirmedList.innerHTML = list.map(n => `
        <div class="listRow">
          <div class="listName">${escapeHtml(n)}</div>
        </div>
      `).join("");
    }

    addUserBtn.addEventListener("click", () => {
      const name = (addUserInput.value || "").trim();
      if (!name) return;
      const users = getUsers();
      if (!users.includes(name)) users.push(name);
      setUsers(users);
      addUserInput.value = "";
      renderUsers();
    });

    saveDeadlineBtn.addEventListener("click", () => {
      const v = deadlineInput.value || "17:00";
      setDeadline(v);
      refreshHome();
      alert("ç· åˆ‡æ™‚é–“ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    savePdfBtn.addEventListener("click", () => {
      const url = (pdfUrlInput.value || "").trim();
      setPdfUrl(url ? url : "#");
      alert("PDFãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    exitAdminBtn.addEventListener("click", () => {
      showScreen("home");
    });

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ====== åˆå›èµ·å‹• ======
    refreshHome();
    // PDFæœªè¨­å®šã§ã‚‚OKï¼ˆç®¡ç†è€…ã§è¨­å®šï¼‰
    // åˆå›ã¯ç™»éŒ²è€…0ã§ã‚‚OKï¼ˆç™»éŒ²è€…ã‚’ä½œã‚‰ãªã„é‹ç”¨ã‚‚å¯èƒ½ï¼‰
    todayText.textContent = todayJP();
    closedDate.textContent = todayISO();

    // ====== PWA: Service Worker ======
    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
