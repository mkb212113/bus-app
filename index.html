<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1f66d1" />
  <title>MKB 春日井｜前日勤務確認</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">MKB 春日井</div>
    <button class="adminBtn" id="openAdminBtn" type="button">管理者</button>
  </header>

  <!-- 画面1：ホーム -->
  <main class="screen active" id="screenHome" aria-label="ホーム">
    <!-- ★変更：タイトル文言のみ（デザインはそのまま） -->
    <h1 class="title">前日勤務確認</h1>

    <button class="goBtn" id="goBtn" type="button" aria-label="GO">GO</button>

    <div class="deadlineWrap" aria-label="締切">
      <!-- ★表示はJSで「ネットでの確認は◯◯まで」に変更 -->
      <div class="deadlineText" id="deadlineText">ネットでの確認は17:00まで</div>
    </div>

    <!-- ★変更：注意文の文言のみ -->
    <div class="homeNote">
      ※確認済みの方は必要ありません。
    </div>

    <!-- ★追加：右下ミニリロード -->
    <button class="reloadMiniBtn" id="miniReloadBtn" type="button" aria-label="更新">↻</button>
  </main>

  <!-- 画面2：名前入力 -->
  <main class="screen" id="screenName" aria-label="名前入力">
    <div class="card">
      <div class="cardTitle">名前を入力してください</div>
      <div class="hint">例：佐藤 太郎</div>

      <input class="textInput" id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="お名前" />

      <button class="primaryBtn" id="nameConfirmBtn" type="button">確認</button>
      <button class="linkBtn" id="backToHomeFromName" type="button">戻る</button>
    </div>
  </main>

  <!-- 画面3：点呼簿（リンク確認） -->
  <main class="screen" id="screenPdf" aria-label="点呼簿">
    <div class="dateRow">
      <span class="badgeNew" id="badgeNew">最新</span>
      <span class="dateText" id="todayText">2026年1月1日</span>
    </div>

    <div class="pdfTitle">点呼簿</div>

    <div class="pdfBox">
      <div class="pdfIcon">PDF</div>
      <div class="pdfFile" id="pdfFileName">点呼簿（リンク）</div>
      <a class="openBtn" id="openPdfLink" href="#" target="_blank" rel="noopener noreferrer">開く</a>
    </div>

    <div class="checkRow">
      <label class="checkLabel">
        <input type="checkbox" id="agreeCheck" />
        <span>確認しました（締切まで）</span>
      </label>
    </div>

    <button class="primaryBtn" id="doneBtn" type="button">確認しました</button>

    <div class="notice">
      ※団体名・個人情報を含むため転用禁止
    </div>

    <button class="linkBtn" id="backToHomeFromPdf" type="button">戻る</button>
  </main>

  <!-- 画面4：締切後 -->
  <main class="screen" id="screenClosed" aria-label="締切後">
    <div class="closedDate" id="closedDate">2026-01-01</div>
    <div class="closedTitle">ネット確認は終了しました。</div>
    <div class="closedSub">電話にて確認してください。</div>
    <div class="phoneIcon">📞</div>
    <button class="linkBtn" id="backToHomeFromClosed" type="button">戻る</button>
  </main>

  <!-- 管理者：PIN -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalSheet">
      <div class="modalTitle">管理者</div>

      <div class="modalHint">暗証番号（4桁）</div>
      <input class="pinInput" id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" />

      <button class="primaryBtn" id="pinEnterBtn" type="button">開く</button>
      <button class="linkBtn" id="closeAdminModal" type="button">閉じる</button>

      <div class="errorText" id="pinError" style="display:none;">暗証番号が違います。</div>
    </div>
  </div>

  <!-- 管理者画面（メンバーは置かない） -->
  <main class="screen" id="screenAdmin" aria-label="管理者画面">
    <h2 class="adminTitle">管理者画面</h2>

    <div class="adminCard">
      <div class="adminSectionTitle">締切時間</div>
      <div class="row">
        <input class="timeInput" id="deadlineInput" type="time" />
        <button class="smallBtn" id="saveDeadlineBtn" type="button">保存</button>
      </div>
      <div class="adminNote">※保存すると、初期画面の締切表示と締切判定に反映されます。</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">点呼簿リンク（PDFでもフォルダでも可）</div>
      <input class="textInput" id="pdfUrlInput" type="url" placeholder="GoogleドライブのURL等を貼り付け" />
      <button class="smallBtn wide" id="savePdfBtn" type="button">保存</button>
      <div class="adminNote">※Googleドライブ共有リンク（フォルダURLもOK）を貼り付けてください。</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">本日の確認者</div>
      <div class="adminList" id="confirmedList"></div>
      <div class="adminNote">※日付ごとに保存されます（ブラウザ保存）。</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">メンバー管理</div>
      <button class="smallBtn wide" id="openMembersBtn" type="button">メンバー管理へ</button>
      <div class="adminNote">※追加・削除はメンバー管理画面で行います。</div>
    </div>

    <button class="linkBtn" id="exitAdminBtn" type="button">ホームへ戻る</button>
  </main>

  <!-- メンバー管理画面 -->
  <main class="screen" id="screenMembers" aria-label="メンバー管理">
    <h2 class="adminTitle">メンバー管理</h2>

    <div class="adminCard">
      <div class="adminSectionTitle">メンバー追加</div>
      <div class="row">
        <input class="textInput" id="addUserInput" type="text" placeholder="追加する名前（フルネーム）" />
        <button class="smallBtn" id="addUserBtn" type="button">追加</button>
      </div>
      <div class="adminNote">※名簿に1人でも登録すると「名簿にない名前」は勤務確認できません。</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">メンバー一覧（削除）</div>
      <div class="adminList" id="userList"></div>
      <div class="adminNote">※退職者は削除してください。</div>
    </div>

    <button class="linkBtn" id="backToAdminFromMembers" type="button">管理者画面へ戻る</button>
  </main>

  <script>
    const ADMIN_PIN = "0900";
    const LS_KEYS = {
      deadline: "mkb_deadline",
      pdfUrl: "mkb_pdf_url",
      users: "mkb_users",
      confirmed: "mkb_confirmed"
    };

    const screens = {
      home: document.getElementById("screenHome"),
      name: document.getElementById("screenName"),
      pdf: document.getElementById("screenPdf"),
      closed: document.getElementById("screenClosed"),
      admin: document.getElementById("screenAdmin"),
      members: document.getElementById("screenMembers"),
    };

    const deadlineText = document.getElementById("deadlineText");
    const goBtn = document.getElementById("goBtn");
    const nameInput = document.getElementById("nameInput");
    const nameConfirmBtn = document.getElementById("nameConfirmBtn");

    const openPdfLink = document.getElementById("openPdfLink");
    const pdfFileName = document.getElementById("pdfFileName");
    const todayText = document.getElementById("todayText");
    const badgeNew = document.getElementById("badgeNew");

    const agreeCheck = document.getElementById("agreeCheck");
    const doneBtn = document.getElementById("doneBtn");
    const closedDate = document.getElementById("closedDate");

    const adminModal = document.getElementById("adminModal");
    const openAdminBtn = document.getElementById("openAdminBtn");
    const closeAdminModal = document.getElementById("closeAdminModal");
    const pinInput = document.getElementById("pinInput");
    const pinEnterBtn = document.getElementById("pinEnterBtn");
    const pinError = document.getElementById("pinError");

    const deadlineInput = document.getElementById("deadlineInput");
    const saveDeadlineBtn = document.getElementById("saveDeadlineBtn");

    const pdfUrlInput = document.getElementById("pdfUrlInput");
    const savePdfBtn = document.getElementById("savePdfBtn");

    const confirmedList = document.getElementById("confirmedList");

    const openMembersBtn = document.getElementById("openMembersBtn");
    const backToAdminFromMembers = document.getElementById("backToAdminFromMembers");

    const addUserInput = document.getElementById("addUserInput");
    const addUserBtn = document.getElementById("addUserBtn");
    const userList = document.getElementById("userList");

    const exitAdminBtn = document.getElementById("exitAdminBtn");

    // ★追加：右下ミニリロード
    const miniReloadBtn = document.getElementById("miniReloadBtn");

    document.getElementById("backToHomeFromName").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromPdf").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromClosed").onclick = () => showScreen("home");

    function pad(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function todayJP(){
      const d = new Date();
      return `${d.getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;
    }
    function nowHHMM(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function getDeadline(){
      return localStorage.getItem(LS_KEYS.deadline) || "17:00";
    }
    function setDeadline(v){
      localStorage.setItem(LS_KEYS.deadline, v);
    }
    function isAfterDeadline(){
      return nowHHMM() > getDeadline();
    }
    function getUsers(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.users) || "[]"); }
      catch { return []; }
    }
    function setUsers(arr){
      localStorage.setItem(LS_KEYS.users, JSON.stringify(arr));
    }
    function getConfirmedAll(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.confirmed) || "{}"); }
      catch { return {}; }
    }
    function setConfirmedAll(obj){
      localStorage.setItem(LS_KEYS.confirmed, JSON.stringify(obj));
    }
    function addConfirmed(name){
      const iso = todayISO();
      const all = getConfirmedAll();
      all[iso] = all[iso] || [];
      if (!all[iso].includes(name)) all[iso].push(name);
      setConfirmedAll(all);
    }
    function getPdfUrl(){
      return localStorage.getItem(LS_KEYS.pdfUrl) || "#";
    }
    function setPdfUrl(url){
      localStorage.setItem(LS_KEYS.pdfUrl, url);
    }

    function showScreen(key){
      Object.values(screens).forEach(el => el.classList.remove("active"));
      screens[key].classList.add("active");
      window.scrollTo({top:0, behavior:"auto"});
    }

    function normalizeName(s){
      let t = String(s || "").trim();
      t = t.replace(/\u3000/g, " ").replace(/\s+/g, " ");
      t = t.replace(/[・･·•.\-ー―‐−]/g, "");
      t = t.replace(/ /g, "");
      return t;
    }
    function levenshtein(a, b){
      a = String(a); b = String(b);
      const m = a.length, n = b.length;
      const dp = Array.from({length:m+1}, () => new Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++){
        for (let j=1;j<=n;j++){
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    function normalizePdfUrl(url){
      let u = String(url || "").trim();
      u = u.replace(/\s+/g, "");
      if (/drive\.google\.com\/drive\/folders\//.test(u)) return u;
      if (u.startsWith("//")) u = "https:" + u;

      const m1 = u.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      const m2 = u.match(/drive\.google\.com\/open\?id=([^&]+)/);
      const m3 = u.match(/drive\.google\.com\/uc\?id=([^&]+)/);
      const fileId = (m1 && m1[1]) || (m2 && m2[1]) || (m3 && m3[1]);
      if (fileId) u = `https://drive.google.com/file/d/${fileId}/view`;
      return u;
    }

    function refreshHome(){
      // ★変更：表示文言のみ
      deadlineText.textContent = `ネットでの確認は${getDeadline()}まで`;
    }

    function refreshPdf(){
      todayText.textContent = todayJP();
      badgeNew.style.display = "inline-block";

      const url = getPdfUrl();
      openPdfLink.href = url === "#" ? "#" : url;
      openPdfLink.classList.toggle("disabled", url === "#");
      pdfFileName.textContent = (url === "#")
        ? "リンク未設定（管理者で設定してください）"
        : "点呼簿（リンク）";

      openPdfLink.onclick = (e) => {
        if (getPdfUrl() === "#"){
          e.preventDefault();
          alert("点呼簿リンクが未設定です。管理者画面で設定してください。");
        }
      };

      agreeCheck.checked = false;
      doneBtn.disabled = true;
      doneBtn.classList.add("disabled");
    }

    goBtn.addEventListener("click", () => {
      refreshHome();
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      showScreen("name");
      setTimeout(()=>nameInput.focus(), 50);
    });

    nameConfirmBtn.addEventListener("click", () => {
      const rawName = (nameInput.value || "").trim();
      if (!rawName){
        alert("名前を入力してください。");
        return;
      }

      const users = getUsers();
      let allowedName = rawName;

      if (users.length > 0){
        const inputN = normalizeName(rawName);
        const idx = users.findIndex(u => normalizeName(u) === inputN);

        if (idx !== -1){
          allowedName = users[idx];
        } else {
          const scored = users
            .map(u => ({ u, d: levenshtein(normalizeName(u), inputN) }))
            .sort((a,b) => a.d - b.d);

          const best = scored[0];
          const threshold = (inputN.length <= 4) ? 0 : (inputN.length <= 7 ? 1 : 2);

          if (best && best.d <= threshold){
            const ok = confirm(`登録名と少し違うかもしれません。\n「${best.u}」として続行しますか？`);
            if (!ok) return;
            allowedName = best.u;
          } else {
            alert("登録されていません。管理者に連絡してください。");
            return;
          }
        }
      }

      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }

      sessionStorage.setItem("mkb_current_name", allowedName);
      nameInput.value = allowedName;

      refreshPdf();
      showScreen("pdf");
    });

    agreeCheck.addEventListener("change", () => {
      const ok = agreeCheck.checked && !isAfterDeadline();
      doneBtn.disabled = !ok;
      doneBtn.classList.toggle("disabled", !ok);
    });

    doneBtn.addEventListener("click", () => {
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      const name = sessionStorage.getItem("mkb_current_name") || "";
      if (!name){
        showScreen("home");
        return;
      }
      addConfirmed(name);
      alert("確認を記録しました。");
      showScreen("home");
      nameInput.value = "";
      sessionStorage.removeItem("mkb_current_name");
    });

    openAdminBtn.addEventListener("click", () => {
      pinInput.value = "";
      pinError.style.display = "none";
      adminModal.classList.add("show");
      adminModal.setAttribute("aria-hidden","false");
      setTimeout(()=>pinInput.focus(), 50);
    });

    closeAdminModal.addEventListener("click", () => {
      adminModal.classList.remove("show");
      adminModal.setAttribute("aria-hidden","true");
    });

    pinEnterBtn.addEventListener("click", () => {
      const pin = (pinInput.value || "").trim();
      if (pin === ADMIN_PIN){
        adminModal.classList.remove("show");
        adminModal.setAttribute("aria-hidden","true");
        openAdmin();
      } else {
        pinError.style.display = "block";
      }
    });

    function openAdmin(){
      deadlineInput.value = getDeadline();
      pdfUrlInput.value = (getPdfUrl() === "#") ? "" : getPdfUrl();
      renderConfirmed();
      showScreen("admin");
    }

    function renderConfirmed(){
      const iso = todayISO();
      const all = getConfirmedAll();
      const list = all[iso] || [];
      if (list.length === 0){
        confirmedList.innerHTML = `<div class="empty">（本日の確認者なし）</div>`;
        return;
      }
      confirmedList.innerHTML = list.map(n => `
        <div class="listRow">
          <div class="listName">${escapeHtml(n)}</div>
        </div>
      `).join("");
    }

    function renderUsers(){
      const users = getUsers();
      if (users.length === 0){
        userList.innerHTML = `<div class="empty">（登録者なし）</div>`;
        return;
      }
      userList.innerHTML = users.map(u => `
        <div class="listRow">
          <div class="listName">${escapeHtml(u)}</div>
          <button class="delBtn" data-name="${encodeURIComponent(u)}" type="button">削除</button>
        </div>
      `).join("");

      userList.querySelectorAll(".delBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = decodeURIComponent(btn.dataset.name || "");
          const next = getUsers().filter(x => x !== name);
          setUsers(next);
          renderUsers();
        });
      });
    }

    addUserBtn.addEventListener("click", () => {
      const name = (addUserInput.value || "").trim();
      if (!name) return;
      const users = getUsers();
      if (!users.includes(name)) users.push(name);
      setUsers(users);
      addUserInput.value = "";
      renderUsers();
    });

    saveDeadlineBtn.addEventListener("click", () => {
      const v = deadlineInput.value || "17:00";
      setDeadline(v);
      refreshHome();
      alert("締切時間を保存しました。");
    });

    savePdfBtn.addEventListener("click", () => {
      const raw = (pdfUrlInput.value || "");
      const url = normalizePdfUrl(raw);
      setPdfUrl(url ? url : "#");
      pdfUrlInput.value = url ? url : "";
      alert("点呼簿リンクを保存しました。");
    });

    openMembersBtn.addEventListener("click", () => {
      renderUsers();
      showScreen("members");
      setTimeout(()=>addUserInput.focus(), 50);
    });

    backToAdminFromMembers.addEventListener("click", () => {
      showScreen("admin");
    });

    exitAdminBtn.addEventListener("click", () => {
      showScreen("home");
    });

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ★追加：右下ミニリロード（強制更新：SW解除 + キャッシュ削除 + 再読み込み）
    async function forceReload(){
      try{
        if ("serviceWorker" in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister()));
        }
        if (window.caches && caches.keys){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }
      }catch(e){
        // 失敗しても再読み込みでOK
      }
      const url = new URL(location.href);
      url.searchParams.set("v", String(Date.now()));
      location.replace(url.toString());
    }
    miniReloadBtn.addEventListener("click", forceReload);

    refreshHome();
    todayText.textContent = todayJP();
    closedDate.textContent = todayISO();

    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
