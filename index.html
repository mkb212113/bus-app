<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1f66d1" />
  <title>MKB æ˜¥æ—¥äº•ï½œå‹¤å‹™ç¢ºèª</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">MKB æ˜¥æ—¥äº•</div>
    <button class="adminBtn" id="openAdminBtn" type="button">ç®¡ç†è€…</button>
  </header>

  <!-- ç”»é¢1ï¼šãƒ›ãƒ¼ãƒ  -->
  <main class="screen active" id="screenHome" aria-label="ãƒ›ãƒ¼ãƒ ">
    <h1 class="title">å‹¤å‹™ç¢ºèª</h1>

    <button class="goBtn" id="goBtn" type="button" aria-label="GO">GO</button>

    <div class="deadlineWrap" aria-label="ç· åˆ‡">
      <div class="deadlineText" id="deadlineText">ç· åˆ‡ï¼š17:00</div>
    </div>

    <div class="homeNote">
      â€»ã™ã§ã«å‹¤å‹™ç¢ºèªã‚’ã—ãŸæ–¹ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
    </div>
  </main>

  <!-- ç”»é¢2ï¼šåå‰å…¥åŠ› -->
  <main class="screen" id="screenName" aria-label="åå‰å…¥åŠ›">
    <div class="card">
      <div class="cardTitle">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      <div class="hint">ä¾‹ï¼šä½è—¤ å¤ªéƒ</div>

      <input class="textInput" id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="ãŠåå‰" />

      <button class="primaryBtn" id="nameConfirmBtn" type="button">ç¢ºèª</button>
      <button class="linkBtn" id="backToHomeFromName" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç”»é¢3ï¼šç‚¹å‘¼ç°¿ï¼ˆãƒªãƒ³ã‚¯ç¢ºèªï¼‰ -->
  <main class="screen" id="screenPdf" aria-label="ç‚¹å‘¼ç°¿">
    <div class="dateRow">
      <span class="badgeNew" id="badgeNew">æœ€æ–°</span>
      <span class="dateText" id="todayText">2026å¹´1æœˆ1æ—¥</span>
    </div>

    <div class="pdfTitle">ç‚¹å‘¼ç°¿</div>

    <div class="pdfBox">
      <div class="pdfIcon">PDF</div>
      <div class="pdfFile" id="pdfFileName">ç‚¹å‘¼ç°¿ï¼ˆãƒªãƒ³ã‚¯ï¼‰</div>
      <a class="openBtn" id="openPdfLink" href="#" target="_blank" rel="noopener noreferrer">é–‹ã</a>
    </div>

    <div class="checkRow">
      <label class="checkLabel">
        <input type="checkbox" id="agreeCheck" />
        <span>ç¢ºèªã—ã¾ã—ãŸï¼ˆç· åˆ‡ã¾ã§ï¼‰</span>
      </label>
    </div>

    <button class="primaryBtn" id="doneBtn" type="button">ç¢ºèªã—ã¾ã—ãŸ</button>

    <div class="notice">
      â€»å›£ä½“åãƒ»å€‹äººæƒ…å ±ã‚’å«ã‚€ãŸã‚è»¢ç”¨ç¦æ­¢
    </div>

    <button class="linkBtn" id="backToHomeFromPdf" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ç”»é¢4ï¼šç· åˆ‡å¾Œ -->
  <main class="screen" id="screenClosed" aria-label="ç· åˆ‡å¾Œ">
    <div class="closedDate" id="closedDate">2026-01-01</div>
    <div class="closedTitle">ãƒãƒƒãƒˆç¢ºèªã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</div>
    <div class="closedSub">é›»è©±ã«ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
    <div class="phoneIcon">ğŸ“</div>
    <button class="linkBtn" id="backToHomeFromClosed" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ç®¡ç†è€…ï¼šPIN -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalSheet">
      <div class="modalTitle">ç®¡ç†è€…</div>

      <div class="modalHint">æš—è¨¼ç•ªå·ï¼ˆ4æ¡ï¼‰</div>
      <input class="pinInput" id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" />

      <button class="primaryBtn" id="pinEnterBtn" type="button">é–‹ã</button>
      <button class="linkBtn" id="closeAdminModal" type="button">é–‰ã˜ã‚‹</button>

      <div class="errorText" id="pinError" style="display:none;">æš—è¨¼ç•ªå·ãŒé•ã„ã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- ç®¡ç†è€…ç”»é¢ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã¯ç½®ã‹ãªã„ï¼‰ -->
  <main class="screen" id="screenAdmin" aria-label="ç®¡ç†è€…ç”»é¢">
    <h2 class="adminTitle">ç®¡ç†è€…ç”»é¢</h2>

    <div class="adminCard">
      <div class="adminSectionTitle">ç· åˆ‡æ™‚é–“</div>
      <div class="row">
        <input class="timeInput" id="deadlineInput" type="time" />
        <button class="smallBtn" id="saveDeadlineBtn" type="button">ä¿å­˜</button>
      </div>
      <div class="adminNote">â€»ä¿å­˜ã™ã‚‹ã¨ã€åˆæœŸç”»é¢ã®ç· åˆ‡è¡¨ç¤ºã¨ç· åˆ‡åˆ¤å®šã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯ï¼ˆPDFã§ã‚‚ãƒ•ã‚©ãƒ«ãƒ€ã§ã‚‚å¯ï¼‰</div>
      <input class="textInput" id="pdfUrlInput" type="url" placeholder="Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®URLç­‰ã‚’è²¼ã‚Šä»˜ã‘" />
      <button class="smallBtn wide" id="savePdfBtn" type="button">ä¿å­˜</button>
      <div class="adminNote">â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–å…±æœ‰ãƒªãƒ³ã‚¯ï¼ˆãƒ•ã‚©ãƒ«ãƒ€URLã‚‚OKï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">æœ¬æ—¥ã®ç¢ºèªè€…</div>
      <div class="adminList" id="confirmedList"></div>
      <div class="adminNote">â€»æ—¥ä»˜ã”ã¨ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰ã€‚</div>
    </div>

    <!-- â˜…ãƒœã‚¿ãƒ³ã ã‘ -->
    <div class="adminCard">
      <div class="adminSectionTitle">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</div>
      <button class="smallBtn wide" id="openMembersBtn" type="button">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã¸</button>
      <div class="adminNote">â€»è¿½åŠ ãƒ»å‰Šé™¤ã¯ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ç”»é¢ã§è¡Œã„ã¾ã™ã€‚</div>
    </div>

    <button class="linkBtn" id="exitAdminBtn" type="button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
  </main>

  <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ç”»é¢ï¼ˆæ–°è¦ï¼‰ -->
  <main class="screen" id="screenMembers" aria-label="ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†">
    <h2 class="adminTitle">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2>

    <div class="adminCard">
      <div class="adminSectionTitle">ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </div>
      <div class="row">
        <input class="textInput" id="addUserInput" type="text" placeholder="è¿½åŠ ã™ã‚‹åå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ ï¼‰" />
        <button class="smallBtn" id="addUserBtn" type="button">è¿½åŠ </button>
      </div>
      <div class="adminNote">â€»åç°¿ã«1äººã§ã‚‚ç™»éŒ²ã™ã‚‹ã¨ã€Œåç°¿ã«ãªã„åå‰ã€ã¯å‹¤å‹™ç¢ºèªã§ãã¾ã›ã‚“ã€‚</div>
    </div>

    <div class="adminCard">
      <div class="adminSectionTitle">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§ï¼ˆå‰Šé™¤ï¼‰</div>
      <div class="adminList" id="userList"></div>
      <div class="adminNote">â€»é€€è·è€…ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <button class="linkBtn" id="backToAdminFromMembers" type="button">ç®¡ç†è€…ç”»é¢ã¸æˆ»ã‚‹</button>
  </main>

  <script>
    const ADMIN_PIN = "0900";
    const LS_KEYS = {
      deadline: "mkb_deadline",
      pdfUrl: "mkb_pdf_url",
      users: "mkb_users",
      confirmed: "mkb_confirmed"
    };

    const screens = {
      home: document.getElementById("screenHome"),
      name: document.getElementById("screenName"),
      pdf: document.getElementById("screenPdf"),
      closed: document.getElementById("screenClosed"),
      admin: document.getElementById("screenAdmin"),
      members: document.getElementById("screenMembers"),
    };

    const deadlineText = document.getElementById("deadlineText");
    const goBtn = document.getElementById("goBtn");
    const nameInput = document.getElementById("nameInput");
    const nameConfirmBtn = document.getElementById("nameConfirmBtn");

    const openPdfLink = document.getElementById("openPdfLink");
    const pdfFileName = document.getElementById("pdfFileName");
    const todayText = document.getElementById("todayText");
    const badgeNew = document.getElementById("badgeNew");

    const agreeCheck = document.getElementById("agreeCheck");
    const doneBtn = document.getElementById("doneBtn");
    const closedDate = document.getElementById("closedDate");

    const adminModal = document.getElementById("adminModal");
    const openAdminBtn = document.getElementById("openAdminBtn");
    const closeAdminModal = document.getElementById("closeAdminModal");
    const pinInput = document.getElementById("pinInput");
    const pinEnterBtn = document.getElementById("pinEnterBtn");
    const pinError = document.getElementById("pinError");

    const deadlineInput = document.getElementById("deadlineInput");
    const saveDeadlineBtn = document.getElementById("saveDeadlineBtn");

    const pdfUrlInput = document.getElementById("pdfUrlInput");
    const savePdfBtn = document.getElementById("savePdfBtn");

    const confirmedList = document.getElementById("confirmedList");

    const openMembersBtn = document.getElementById("openMembersBtn");
    const backToAdminFromMembers = document.getElementById("backToAdminFromMembers");

    const addUserInput = document.getElementById("addUserInput");
    const addUserBtn = document.getElementById("addUserBtn");
    const userList = document.getElementById("userList");

    const exitAdminBtn = document.getElementById("exitAdminBtn");

    document.getElementById("backToHomeFromName").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromPdf").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromClosed").onclick = () => showScreen("home");

    function pad(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function todayJP(){
      const d = new Date();
      return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    }
    function nowHHMM(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function getDeadline(){
      return localStorage.getItem(LS_KEYS.deadline) || "17:00";
    }
    function setDeadline(v){
      localStorage.setItem(LS_KEYS.deadline, v);
    }
    function isAfterDeadline(){
      return nowHHMM() > getDeadline();
    }
    function getUsers(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.users) || "[]"); }
      catch { return []; }
    }
    function setUsers(arr){
      localStorage.setItem(LS_KEYS.users, JSON.stringify(arr));
    }
    function getConfirmedAll(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.confirmed) || "{}"); }
      catch { return {}; }
    }
    function setConfirmedAll(obj){
      localStorage.setItem(LS_KEYS.confirmed, JSON.stringify(obj));
    }
    function addConfirmed(name){
      const iso = todayISO();
      const all = getConfirmedAll();
      all[iso] = all[iso] || [];
      if (!all[iso].includes(name)) all[iso].push(name);
      setConfirmedAll(all);
    }
    function getPdfUrl(){
      return localStorage.getItem(LS_KEYS.pdfUrl) || "#";
    }
    function setPdfUrl(url){
      localStorage.setItem(LS_KEYS.pdfUrl, url);
    }

    function showScreen(key){
      Object.values(screens).forEach(el => el.classList.remove("active"));
      screens[key].classList.add("active");
      window.scrollTo({top:0, behavior:"auto"});
    }

    function normalizeName(s){
      let t = String(s || "").trim();
      t = t.replace(/\u3000/g, " ").replace(/\s+/g, " ");
      t = t.replace(/[ãƒ»ï½¥Â·â€¢.\-ãƒ¼â€•â€âˆ’]/g, "");
      t = t.replace(/ /g, "");
      return t;
    }
    function levenshtein(a, b){
      a = String(a); b = String(b);
      const m = a.length, n = b.length;
      const dp = Array.from({length:m+1}, () => new Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++){
        for (let j=1;j<=n;j++){
          const cost = a[i-1] === b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }

    function normalizePdfUrl(url){
      let u = String(url || "").trim();
      u = u.replace(/\s+/g, "");
      if (/drive\.google\.com\/drive\/folders\//.test(u)) return u;
      if (u.startsWith("//")) u = "https:" + u;

      const m1 = u.match(/drive\.google\.com\/file\/d\/([^/]+)/);
      const m2 = u.match(/drive\.google\.com\/open\?id=([^&]+)/);
      const m3 = u.match(/drive\.google\.com\/uc\?id=([^&]+)/);
      const fileId = (m1 && m1[1]) || (m2 && m2[1]) || (m3 && m3[1]);
      if (fileId) u = `https://drive.google.com/file/d/${fileId}/view`;
      return u;
    }

    function refreshHome(){
      deadlineText.textContent = `ç· åˆ‡ï¼š${getDeadline()}`;
    }

    function refreshPdf(){
      todayText.textContent = todayJP();
      badgeNew.style.display = "inline-block";

      const url = getPdfUrl();
      openPdfLink.href = url === "#" ? "#" : url;
      openPdfLink.classList.toggle("disabled", url === "#");
      pdfFileName.textContent = (url === "#")
        ? "ãƒªãƒ³ã‚¯æœªè¨­å®šï¼ˆç®¡ç†è€…ã§è¨­å®šã—ã¦ãã ã•ã„ï¼‰"
        : "ç‚¹å‘¼ç°¿ï¼ˆãƒªãƒ³ã‚¯ï¼‰";

      openPdfLink.onclick = (e) => {
        if (getPdfUrl() === "#"){
          e.preventDefault();
          alert("ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯ãŒæœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ç”»é¢ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        }
      };

      agreeCheck.checked = false;
      doneBtn.disabled = true;
      doneBtn.classList.add("disabled");
    }

    goBtn.addEventListener("click", () => {
      refreshHome();
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      showScreen("name");
      setTimeout(()=>nameInput.focus(), 50);
    });

    nameConfirmBtn.addEventListener("click", () => {
      const rawName = (nameInput.value || "").trim();
      if (!rawName){
        alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const users = getUsers();
      let allowedName = rawName;

      if (users.length > 0){
        const inputN = normalizeName(rawName);
        const idx = users.findIndex(u => normalizeName(u) === inputN);

        if (idx !== -1){
          allowedName = users[idx];
        } else {
          const scored = users
            .map(u => ({ u, d: levenshtein(normalizeName(u), inputN) }))
            .sort((a,b) => a.d - b.d);

          const best = scored[0];
          const threshold = (inputN.length <= 4) ? 0 : (inputN.length <= 7 ? 1 : 2);

          if (best && best.d <= threshold){
            const ok = confirm(`ç™»éŒ²åã¨å°‘ã—é•ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚\nã€Œ${best.u}ã€ã¨ã—ã¦ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`);
            if (!ok) return;
            allowedName = best.u;
          } else {
            alert("ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
            return;
          }
        }
      }

      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }

      sessionStorage.setItem("mkb_current_name", allowedName);
      nameInput.value = allowedName;

      refreshPdf();
      showScreen("pdf");
    });

    agreeCheck.addEventListener("change", () => {
      const ok = agreeCheck.checked && !isAfterDeadline();
      doneBtn.disabled = !ok;
      doneBtn.classList.toggle("disabled", !ok);
    });

    doneBtn.addEventListener("click", () => {
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      const name = sessionStorage.getItem("mkb_current_name") || "";
      if (!name){
        showScreen("home");
        return;
      }
      addConfirmed(name);
      alert("ç¢ºèªã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚");
      showScreen("home");
      nameInput.value = "";
      sessionStorage.removeItem("mkb_current_name");
    });

    openAdminBtn.addEventListener("click", () => {
      pinInput.value = "";
      pinError.style.display = "none";
      adminModal.classList.add("show");
      adminModal.setAttribute("aria-hidden","false");
      setTimeout(()=>pinInput.focus(), 50);
    });

    closeAdminModal.addEventListener("click", () => {
      adminModal.classList.remove("show");
      adminModal.setAttribute("aria-hidden","true");
    });

    pinEnterBtn.addEventListener("click", () => {
      const pin = (pinInput.value || "").trim();
      if (pin === ADMIN_PIN){
        adminModal.classList.remove("show");
        adminModal.setAttribute("aria-hidden","true");
        openAdmin();
      } else {
        pinError.style.display = "block";
      }
    });

    function openAdmin(){
      deadlineInput.value = getDeadline();
      pdfUrlInput.value = (getPdfUrl() === "#") ? "" : getPdfUrl();
      renderConfirmed();
      showScreen("admin");
    }

    function renderConfirmed(){
      const iso = todayISO();
      const all = getConfirmedAll();
      const list = all[iso] || [];
      if (list.length === 0){
        confirmedList.innerHTML = `<div class="empty">ï¼ˆæœ¬æ—¥ã®ç¢ºèªè€…ãªã—ï¼‰</div>`;
        return;
      }
      confirmedList.innerHTML = list.map(n => `
        <div class="listRow">
          <div class="listName">${escapeHtml(n)}</div>
        </div>
      `).join("");
    }

    function renderUsers(){
      const users = getUsers();
      if (users.length === 0){
        userList.innerHTML = `<div class="empty">ï¼ˆç™»éŒ²è€…ãªã—ï¼‰</div>`;
        return;
      }
      userList.innerHTML = users.map(u => `
        <div class="listRow">
          <div class="listName">${escapeHtml(u)}</div>
          <button class="delBtn" data-name="${encodeURIComponent(u)}" type="button">å‰Šé™¤</button>
        </div>
      `).join("");

      userList.querySelectorAll(".delBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = decodeURIComponent(btn.dataset.name || "");
          const next = getUsers().filter(x => x !== name);
          setUsers(next);
          renderUsers();
        });
      });
    }

    addUserBtn.addEventListener("click", () => {
      const name = (addUserInput.value || "").trim();
      if (!name) return;
      const users = getUsers();
      if (!users.includes(name)) users.push(name);
      setUsers(users);
      addUserInput.value = "";
      renderUsers();
    });

    saveDeadlineBtn.addEventListener("click", () => {
      const v = deadlineInput.value || "17:00";
      setDeadline(v);
      refreshHome();
      alert("ç· åˆ‡æ™‚é–“ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    savePdfBtn.addEventListener("click", () => {
      const raw = (pdfUrlInput.value || "");
      const url = normalizePdfUrl(raw);
      setPdfUrl(url ? url : "#");
      pdfUrlInput.value = url ? url : "";
      alert("ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    openMembersBtn.addEventListener("click", () => {
      renderUsers();
      showScreen("members");
      setTimeout(()=>addUserInput.focus(), 50);
    });

    backToAdminFromMembers.addEventListener("click", () => {
      showScreen("admin");
    });

    exitAdminBtn.addEventListener("click", () => {
      showScreen("home");
    });

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    refreshHome();
    todayText.textContent = todayJP();
    closedDate.textContent = todayISO();

    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
