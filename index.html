<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2a73d6" />
  <title>å‹¤å‹™ç¢ºèª</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ====== å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¸Šã ã‘ï¼‰ ====== -->
  <header class="topbar">
    <div class="brand">MKB æ˜¥æ—¥äº•</div>
    <button class="adminBtn" id="openAdminBtn" type="button">ç®¡ç†è€…</button>
  </header>

  <!-- ====== ç”»é¢1ï¼šãƒ›ãƒ¼ãƒ  ====== -->
  <main class="screen active" id="screenHome" aria-label="ãƒ›ãƒ¼ãƒ ">
    <h1 class="title">å‹¤å‹™ç¢ºèª</h1>

    <button class="goBtn" id="goBtn" type="button" aria-label="GO">
      <span>GO</span>
    </button>

    <!-- GOã®ä¸‹ã«ãƒã‚¹ï¼ˆç”»é¢ä¸‹ã®æ–¹ã«é…ç½®ï¼‰ -->
    <div class="busWrap" aria-hidden="false">
      <!-- ç”»åƒã¯ /images/bus.png ã‚’ç½®ã„ã¦ãã ã•ã„ -->
      <img class="busImg" src="images/bus.png" alt="ãƒã‚¹ã®ã‚¤ãƒ©ã‚¹ãƒˆ" />
    </div>

    <div class="deadline" id="deadlineText">ç· åˆ‡ï¼š16:50</div>
  </main>

  <!-- ====== ç”»é¢2ï¼šåå‰å…¥åŠ› ====== -->
  <main class="screen" id="screenName" aria-label="åå‰å…¥åŠ›">
    <h2 class="subTitle">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>

    <div class="card">
      <label class="label" for="nameInput">ä¾‹ï¼šä½è—¤ å¤ªéƒ</label>
      <input class="textInput" id="nameInput" type="text" inputmode="text" autocomplete="name" />
      <button class="primaryBtn" id="saveNameBtn" type="button">ç¢ºèª</button>
    </div>

    <button class="linkBtn" data-back="home" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ====== ç”»é¢3ï¼šç‚¹å‘¼ç°¿ï¼ˆé–²è¦§ï¼‹ãƒã‚§ãƒƒã‚¯ï¼‰ ====== -->
  <main class="screen" id="screenPdf" aria-label="ç‚¹å‘¼ç°¿">
    <div class="dateLine" id="todayLine"></div>

    <div class="pdfCard">
      <div class="pdfTitle">ç‚¹å‘¼ç°¿</div>

      <!-- ç®¡ç†è€…ãŒè¨­å®šã—ãŸURL or æ—¢å®šã®PDF -->
      <a class="openPdfBtn" id="openPdfBtn" href="#" target="_blank" rel="noopener">é–‹ã</a>

      <div class="checkRow">
        <label class="checkLabel">
          <input id="agreeChk" type="checkbox" />
          <span>ç¢ºèªã—ã¾ã—ãŸï¼ˆ16:50ã¾ã§ï¼‰</span>
        </label>
      </div>

      <button class="primaryBtn" id="submitBtn" type="button" disabled>ç¢ºèªã—ã¾ã—ãŸ</button>

      <div class="miniNote" id="whoInfo"></div>
    </div>

    <button class="linkBtn" data-back="home" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ====== ç”»é¢4ï¼šç· åˆ‡å¾Œï¼ˆé›»è©±è¡¨ç¤ºï¼‰ ====== -->
  <main class="screen" id="screenClosed" aria-label="ç· åˆ‡å¾Œ">
    <div class="dateLine" id="closedDateLine"></div>
    <h2 class="closedTitle">ãƒãƒƒãƒˆç¢ºèªã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</h2>
    <div class="closedText">é›»è©±ã«ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
    <div class="phoneIcon" aria-hidden="true">ğŸ“</div>
    <button class="linkBtn" data-back="home" type="button">æˆ»ã‚‹</button>

    <!-- ãƒã‚¹ç”»åƒãŒã“ã®ç”»é¢ã«å‡ºãªã„ã‚ˆã†ã«ã—ãŸã„å ´åˆã¯ã€ä¸‹ã¯ç„¡ã— -->
  </main>

  <!-- ====== ç®¡ç†è€…ï¼šæš—è¨¼ç•ªå· ====== -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³">
      <div class="modalTitle">ç®¡ç†è€…</div>

      <label class="label" for="pinInput">æš—è¨¼ç•ªå·ï¼ˆ4æ¡ï¼‰</label>
      <input class="textInput" id="pinInput" type="password" inputmode="numeric" maxlength="4" autocomplete="one-time-code" placeholder="â€¢â€¢â€¢â€¢" />

      <div class="modalBtns">
        <button class="ghostBtn" id="closeAdminBtn" type="button">é–‰ã˜ã‚‹</button>
        <button class="primaryBtn" id="loginAdminBtn" type="button">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </div>

      <div class="errorText" id="pinError" aria-live="polite"></div>
    </div>
  </div>

  <!-- ====== ç®¡ç†è€…ç”»é¢ï¼ˆPDF URLè¨­å®šï¼‹ç¢ºèªè€…ä¸€è¦§ï¼‰ ====== -->
  <main class="screen" id="screenAdmin" aria-label="ç®¡ç†è€…ç”»é¢">
    <h2 class="subTitle">ç®¡ç†è€…ç”»é¢</h2>

    <div class="card">
      <div class="sectionTitle">ç‚¹å‘¼ç°¿PDFã®URL</div>
      <input class="textInput" id="pdfUrlInput" type="url" placeholder="https://...pdf" />
      <button class="primaryBtn" id="savePdfUrlBtn" type="button">ä¿å­˜</button>
      <div class="miniNote">â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–å…±æœ‰ãƒªãƒ³ã‚¯ç­‰ã‚’è²¼ã£ã¦ãã ã•ã„ï¼ˆç¤¾å†…é‹ç”¨ã«åˆã‚ã›ã¦ï¼‰</div>
    </div>

    <div class="card">
      <div class="sectionTitle">ç¢ºèªè€…ä¸€è¦§ï¼ˆä»Šæ—¥ï¼‰</div>
      <div class="adminList" id="adminTodayList"></div>
      <hr class="hr" />
      <div class="sectionTitle">ç¢ºèªè€…ä¸€è¦§ï¼ˆéå»7æ—¥ï¼‰</div>
      <div class="adminList" id="adminWeekList"></div>
    </div>

    <button class="linkBtn" data-back="home" type="button">æˆ»ã‚‹</button>
  </main>

  <script>
    // ====== è¨­å®š ======
    const DEADLINE_HOUR = 16;
    const DEADLINE_MIN = 50;
    const ADMIN_PIN = "0900";
    const DEFAULT_PDF_URL = "ã‚¹ã‚­ãƒ£ãƒ³_20251104-1111.pdf"; // æ—¢å®šï¼ˆå¿…è¦ãªã‚‰å¤‰æ›´ï¼‰

    // ====== è¦ç´  ======
    const screens = {
      home: document.getElementById("screenHome"),
      name: document.getElementById("screenName"),
      pdf: document.getElementById("screenPdf"),
      closed: document.getElementById("screenClosed"),
      admin: document.getElementById("screenAdmin"),
    };

    const goBtn = document.getElementById("goBtn");
    const nameInput = document.getElementById("nameInput");
    const saveNameBtn = document.getElementById("saveNameBtn");

    const openPdfBtn = document.getElementById("openPdfBtn");
    const agreeChk = document.getElementById("agreeChk");
    const submitBtn = document.getElementById("submitBtn");
    const whoInfo = document.getElementById("whoInfo");

    const todayLine = document.getElementById("todayLine");
    const closedDateLine = document.getElementById("closedDateLine");

    const openAdminBtn = document.getElementById("openAdminBtn");
    const adminModal = document.getElementById("adminModal");
    const closeAdminBtn = document.getElementById("closeAdminBtn");
    const loginAdminBtn = document.getElementById("loginAdminBtn");
    const pinInput = document.getElementById("pinInput");
    const pinError = document.getElementById("pinError");

    const pdfUrlInput = document.getElementById("pdfUrlInput");
    const savePdfUrlBtn = document.getElementById("savePdfUrlBtn");
    const adminTodayList = document.getElementById("adminTodayList");
    const adminWeekList = document.getElementById("adminWeekList");

    // ====== å…±é€šé–¢æ•° ======
    function showScreen(key) {
      Object.values(screens).forEach(el => el.classList.remove("active"));
      screens[key].classList.add("active");
      window.scrollTo(0,0);
    }

    function pad2(n){ return String(n).padStart(2,"0"); }
    function todayKey(d=new Date()){
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function deadlineDate(d=new Date()){
      const x = new Date(d);
      x.setHours(DEADLINE_HOUR, DEADLINE_MIN, 0, 0);
      return x;
    }

    function isAfterDeadline(now=new Date()){
      return now.getTime() > deadlineDate(now).getTime();
    }

    function getName(){
      return localStorage.getItem("mkb_name") || "";
    }

    function setName(v){
      localStorage.setItem("mkb_name", v.trim());
    }

    function getPdfUrl(){
      return localStorage.getItem("mkb_pdf_url") || DEFAULT_PDF_URL;
    }

    function setPdfUrl(v){
      localStorage.setItem("mkb_pdf_url", v.trim());
    }

    // ç¢ºèªè€…ä¿å­˜ï¼šlocalStorageï¼ˆã‚µãƒ¼ãƒãƒ¼ç„¡ã—ï¼‰
    function getConfirmMap(){
      try { return JSON.parse(localStorage.getItem("mkb_confirm_map") || "{}"); }
      catch { return {}; }
    }
    function saveConfirmMap(map){
      localStorage.setItem("mkb_confirm_map", JSON.stringify(map));
    }

    function addConfirm(name){
      const key = todayKey();
      const map = getConfirmMap();
      map[key] = map[key] || [];
      if(!map[key].includes(name)) map[key].push(name);
      saveConfirmMap(map);
    }

    function renderWho(){
      const key = todayKey();
      const map = getConfirmMap();
      const arr = map[key] || [];
      whoInfo.textContent = arr.length ? `æœ¬æ—¥ç¢ºèªï¼š${arr.join("ã€")}` : "æœ¬æ—¥ç¢ºèªï¼šã¾ã ã‚ã‚Šã¾ã›ã‚“";
    }

    function renderAdminLists(){
      const map = getConfirmMap();
      const t = todayKey();
      const todayArr = map[t] || [];
      adminTodayList.textContent = todayArr.length ? todayArr.join("ã€") : "ã¾ã ã‚ã‚Šã¾ã›ã‚“";

      // éå»7æ—¥
      const list = [];
      const now = new Date();
      for(let i=0;i<7;i++){
        const d = new Date(now);
        d.setDate(now.getDate()-i);
        const k = todayKey(d);
        if(map[k] && map[k].length){
          list.push(`${k}ï¼š${map[k].join("ã€")}`);
        }
      }
      adminWeekList.innerHTML = list.length ? list.map(x=>`<div class="dayRow">${x}</div>`).join("") : "è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“";
    }

    function syncPdfLink(){
      openPdfBtn.href = getPdfUrl();
    }

    function syncDateLines(){
      const t = todayKey();
      todayLine.textContent = t;
      closedDateLine.textContent = t;
    }

    function goFlow(){
      syncDateLines();
      syncPdfLink();

      if(isAfterDeadline()){
        showScreen("closed");
        return;
      }

      const name = getName();
      if(!name){
        showScreen("name");
        setTimeout(()=>nameInput.focus(), 50);
      }else{
        showScreen("pdf");
        agreeChk.checked = false;
        submitBtn.disabled = true;
        renderWho();
      }
    }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
    goBtn.addEventListener("click", goFlow);

    saveNameBtn.addEventListener("click", ()=>{
      const v = nameInput.value.trim();
      if(!v){
        nameInput.focus();
        return;
      }
      setName(v);
      goFlow();
    });

    agreeChk.addEventListener("change", ()=>{
      submitBtn.disabled = !agreeChk.checked;
    });

    submitBtn.addEventListener("click", ()=>{
      if(isAfterDeadline()){
        showScreen("closed");
        return;
      }
      const name = getName();
      if(!name){
        showScreen("name");
        return;
      }
      addConfirm(name);
      renderWho();
      submitBtn.disabled = true;
      agreeChk.checked = false;
      // è»½ããƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      submitBtn.textContent = "è¨˜éŒ²ã—ã¾ã—ãŸ";
      setTimeout(()=>submitBtn.textContent = "ç¢ºèªã—ã¾ã—ãŸ", 900);
    });

    document.querySelectorAll("[data-back]").forEach(btn=>{
      btn.addEventListener("click", ()=>showScreen("home"));
    });

    // ç®¡ç†è€…
    openAdminBtn.addEventListener("click", ()=>{
      pinInput.value = "";
      pinError.textContent = "";
      adminModal.classList.add("open");
      adminModal.setAttribute("aria-hidden","false");
      setTimeout(()=>pinInput.focus(), 50);
    });

    closeAdminBtn.addEventListener("click", ()=>{
      adminModal.classList.remove("open");
      adminModal.setAttribute("aria-hidden","true");
    });

    loginAdminBtn.addEventListener("click", ()=>{
      if(pinInput.value === ADMIN_PIN){
        adminModal.classList.remove("open");
        adminModal.setAttribute("aria-hidden","true");
        // ç®¡ç†ç”»é¢ã¸
        pdfUrlInput.value = getPdfUrl();
        renderAdminLists();
        showScreen("admin");
      }else{
        pinError.textContent = "æš—è¨¼ç•ªå·ãŒé•ã„ã¾ã™ã€‚";
        pinInput.focus();
      }
    });

    savePdfUrlBtn.addEventListener("click", ()=>{
      const v = pdfUrlInput.value.trim();
      if(!v) return;
      setPdfUrl(v);
      syncPdfLink();
      savePdfUrlBtn.textContent = "ä¿å­˜ã—ã¾ã—ãŸ";
      setTimeout(()=>savePdfUrlBtn.textContent = "ä¿å­˜", 900);
    });

    // åˆæœŸè¡¨ç¤º
    syncDateLines();
    syncPdfLink();

    // PWA (ä»»æ„ï¼šsw.jsãŒã‚ã‚‹å ´åˆã ã‘ç™»éŒ²)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
