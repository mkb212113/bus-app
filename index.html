<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>å‹¤å‹™ç¢ºèª</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />
  <meta name="theme-color" content="#1f6fd6" />
</head>
<body>
  <!-- ä¸Šéƒ¨ãƒãƒ¼ï¼ˆä¸‹éƒ¨ã¯ä½œã‚Šã¾ã›ã‚“ï¼‰ -->
  <header class="topbar">
    <div class="brand" aria-label="ãƒ­ã‚´">MKB æ˜¥æ—¥äº•</div>
    <button class="adminBtn" id="openAdminBtn" type="button">ç®¡ç†è€…</button>
  </header>

  <!-- ç”»é¢ï¼šãƒ›ãƒ¼ãƒ  -->
  <main class="screen active" id="screenHome">
    <h1 class="title">å‹¤å‹™ç¢ºèª</h1>

    <button class="goBtn" id="goBtn" type="button" aria-label="GO">
      GO
    </button>
    <img src="bus.png" alt="ãƒã‚¹ã®ã‚¤ãƒ©ã‚¹ãƒˆ" class="bus-image">


    <div class="hint">
      <div>ç· åˆ‡ï¼š<b>16:50</b></div>
      <div class="small">â€»ç· åˆ‡å¾Œã¯ã€Œé›»è©±ã§ç¢ºèªã—ã¦ãã ã•ã„ã€ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>
  </main>

  <!-- ç”»é¢ï¼šåå‰å…¥åŠ›ï¼ˆåˆå›ã ã‘ï¼‰ -->
  <main class="screen" id="screenName">
    <h2 class="subTitle">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>

    <div class="card">
      <label class="label" for="nameInput">ãŠåå‰</label>
      <input class="textInput" id="nameInput" type="text" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" autocomplete="name" />
      <button class="primaryBtn" id="saveNameBtn" type="button">ç¢ºèª</button>
      <button class="linkBtn" id="backToHome1" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç”»é¢ï¼šç‚¹å‘¼ç°¿ï¼ˆPDFï¼‰ -->
  <main class="screen" id="screenPdf">
    <div class="sectionHead">
      <div class="dateLine" id="pdfDateLine">æ—¥ä»˜</div>
      <div class="badgeNew" id="badgeNew" hidden>æœ€æ–°</div>
    </div>

    <h2 class="subTitle">ç‚¹å‘¼ç°¿</h2>

    <div class="pdfCard">
      <div class="pdfInfo">
        <div class="pdfName" id="pdfName">PDFãŒæœªè¨­å®šã§ã™</div>
        <a class="primaryBtn full" id="pdfOpenBtn" href="#" target="_blank" rel="noopener">é–‹ã</a>
      </div>

      <!-- ç«¯æœ«ã«ã‚ˆã£ã¦ã¯åŸ‹ã‚è¾¼ã¿ãŒåŠ¹ã‹ãªã„ã®ã§ã€ã†ã¾ãã„ã‹ãªã„æ™‚ã¯ã€Œé–‹ãã€ãƒœã‚¿ãƒ³ã§OK -->
      <iframe class="pdfFrame" id="pdfFrame" title="PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" loading="lazy"></iframe>
    </div>

    <div class="confirmRow">
      <label class="checkWrap">
        <input id="confirmCheckbox" type="checkbox" />
        <span>ç¢ºèªã—ã¾ã—ãŸï¼ˆ16:50ã¾ã§ï¼‰</span>
      </label>
      <button class="primaryBtn" id="confirmBtn" type="button" disabled>ç¢ºèªã—ã¾ã—ãŸ</button>
    </div>

    <div class="miniInfo" id="whoLine"></div>

    <button class="linkBtn" id="backToHome2" type="button">æˆ»ã‚‹</button>
  </main>

  <!-- ç”»é¢ï¼šç· åˆ‡å¾Œ -->
  <main class="screen" id="screenClosed">
    <div class="closedWrap">
      <div class="dateLine" id="closedDateLine">æ—¥ä»˜</div>
      <h2 class="subTitle">ãƒãƒƒãƒˆç¢ºèªã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</h2>
      <p class="closedText">é›»è©±ã«ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
      <div class="phoneIcon">ğŸ“</div>
      <button class="linkBtn" id="backToHome3" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç”»é¢ï¼šç®¡ç†è€… -->
  <main class="screen" id="screenAdmin">
    <h2 class="subTitle">ç®¡ç†è€…ç”»é¢</h2>

    <div class="card">
      <div class="label">ç‚¹å‘¼ç°¿PDFã®è¨­å®šï¼ˆä»Šæ—¥ã®åˆ†ï¼‰</div>

      <label class="label small" for="pdfUrlInput">PDFã®URLï¼ˆGitHubã‚„Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®å…±æœ‰ãƒªãƒ³ã‚¯ï¼‰</label>
      <input class="textInput" id="pdfUrlInput" type="url" placeholder="https://..." />

      <label class="label small" for="pdfLabelInput">è¡¨ç¤ºåï¼ˆä»»æ„ï¼‰</label>
      <input class="textInput" id="pdfLabelInput" type="text" placeholder="ä¾‹ï¼šç‚¹å‘¼ç°¿_2025-01-01.pdf" />

      <button class="primaryBtn" id="savePdfBtn" type="button">ä¿å­˜</button>

      <hr class="hr" />

      <div class="label">ç¢ºèªè€…ä¸€è¦§ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹åˆ†ï¼‰</div>
      <div class="adminList" id="adminList"></div>

      <div class="adminActions">
        <button class="dangerBtn" id="clearTodayBtn" type="button">ä»Šæ—¥ã®ç¢ºèªã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="dangerBtn" id="clearAllBtn" type="button">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆã“ã®ç«¯æœ«ï¼‰</button>
      </div>

      <button class="linkBtn" id="backToHome4" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const DEADLINE_HOUR = 16;
const DEADLINE_MIN  = 50;
const ADMIN_PIN = "0900";

const LS_NAME_KEY = "mkb_name";
const LS_PDF_KEY  = "mkb_pdf";       // {url,label,updatedAt}
const LS_LOG_KEY  = "mkb_confirmLog"; // { "YYYY-MM-DD": [{name,time}] }

/* ===== ä¾¿åˆ©é–¢æ•° ===== */
const $ = (id) => document.getElementById(id);

function todayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const da = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function nowTimeStr() {
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  return `${hh}:${mm}`;
}
function isPastDeadline() {
  const d = new Date();
  const h = d.getHours();
  const m = d.getMinutes();
  if (h > DEADLINE_HOUR) return true;
  if (h < DEADLINE_HOUR) return false;
  return m >= DEADLINE_MIN;
}
function showScreen(screenId) {
  ["screenHome","screenName","screenPdf","screenClosed","screenAdmin"].forEach(id=>{
    $(id).classList.toggle("active", id === screenId);
  });
  // ä¸Šéƒ¨ãƒãƒ¼ã®ç®¡ç†è€…ãƒœã‚¿ãƒ³ã¯å…¨ç”»é¢ã§è¦‹ã›ã‚‹ï¼ˆè¦‹æ „ãˆå„ªå…ˆï¼‰
  window.scrollTo({ top: 0, behavior: "instant" });
}

/* ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿æ›¸ã ===== */
function loadName() { return localStorage.getItem(LS_NAME_KEY) || ""; }
function saveName(v) { localStorage.setItem(LS_NAME_KEY, v.trim()); }

function loadPdf() {
  try { return JSON.parse(localStorage.getItem(LS_PDF_KEY) || "null"); }
  catch { return null; }
}
function savePdf(obj) {
  localStorage.setItem(LS_PDF_KEY, JSON.stringify(obj));
}

function loadLog() {
  try { return JSON.parse(localStorage.getItem(LS_LOG_KEY) || "{}"); }
  catch { return {}; }
}
function saveLog(obj) {
  localStorage.setItem(LS_LOG_KEY, JSON.stringify(obj));
}

/* ===== ç”»é¢æ›´æ–° ===== */
function refreshPdfScreen() {
  const tKey = todayKey();
  $("pdfDateLine").textContent = tKey;
  $("closedDateLine").textContent = tKey;

  // PDFæƒ…å ±
  const pdf = loadPdf();
  if (!pdf || !pdf.url) {
    $("pdfName").textContent = "PDFãŒæœªè¨­å®šã§ã™ï¼ˆç®¡ç†è€…ã§è¨­å®šã—ã¦ãã ã•ã„ï¼‰";
    $("pdfOpenBtn").href = "#";
    $("pdfOpenBtn").classList.add("disabled");
    $("pdfFrame").src = "";
  } else {
    $("pdfName").textContent = (pdf.label && pdf.label.trim()) ? pdf.label.trim() : pdf.url;
    $("pdfOpenBtn").href = pdf.url;
    $("pdfOpenBtn").classList.remove("disabled");

    // iframeï¼ˆåŠ¹ã‹ãªã„ç«¯æœ«ã‚‚ã‚ã‚‹ã®ã§ã€ãƒ€ãƒ¡ãªã‚‰ã€Œé–‹ãã€ã§OKï¼‰
    $("pdfFrame").src = pdf.url;

    // æœ€æ–°ãƒãƒƒã‚¸ï¼ˆ24æ™‚é–“ä»¥å†…ã«æ›´æ–°ãªã‚‰è¡¨ç¤ºï¼‰
    const updated = Number(pdf.updatedAt || 0);
    const isNew = (Date.now() - updated) < 24*60*60*1000;
    $("badgeNew").hidden = !isNew;
  }

  // ç¢ºèªè€…è¡¨ç¤ºï¼ˆä»Šæ—¥åˆ†ï¼‰
  const log = loadLog();
  const list = log[tKey] || [];
  if (list.length === 0) {
    $("whoLine").textContent = "ã¾ã ç¢ºèªè€…ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
  } else {
    const names = list.map(x => x.name).join("ã€");
    $("whoLine").textContent = `ç¢ºèªæ¸ˆã¿ï¼š${names}`;
  }

  // ç· åˆ‡åˆ¶å¾¡
  const past = isPastDeadline();
  $("confirmCheckbox").disabled = past;
  $("confirmBtn").disabled = past || !$("confirmCheckbox").checked;
}

/* ===== ç®¡ç†è€…ç”»é¢æ›´æ–° ===== */
function refreshAdmin() {
  const pdf = loadPdf() || {};
  $("pdfUrlInput").value = pdf.url || "";
  $("pdfLabelInput").value = pdf.label || "";

  const log = loadLog();
  const keys = Object.keys(log).sort().reverse();

  if (keys.length === 0) {
    $("adminList").innerHTML = "<div class='muted'>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
    return;
  }

  let html = "";
  for (const k of keys) {
    const rows = log[k] || [];
    const names = rows.map(r => `${r.name}ï¼ˆ${r.time}ï¼‰`).join("<br>");
    html += `
      <div class="adminDay">
        <div class="adminDayTitle">${k}</div>
        <div class="adminDayBody">${names || "<span class='muted'>ãªã—</span>"}</div>
      </div>
    `;
  }
  $("adminList").innerHTML = html;
}

/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
$("goBtn").addEventListener("click", () => {
  if (isPastDeadline()) {
    showScreen("screenClosed");
    refreshPdfScreen();
    return;
  }
  const name = loadName();
  if (!name) {
    showScreen("screenName");
  } else {
    showScreen("screenPdf");
    refreshPdfScreen();
  }
});

$("saveNameBtn").addEventListener("click", () => {
  const v = $("nameInput").value.trim();
  if (!v) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  saveName(v);
  showScreen("screenPdf");
  refreshPdfScreen();
});

$("backToHome1").addEventListener("click", () => showScreen("screenHome"));
$("backToHome2").addEventListener("click", () => showScreen("screenHome"));
$("backToHome3").addEventListener("click", () => showScreen("screenHome"));
$("backToHome4").addEventListener("click", () => showScreen("screenHome"));

$("confirmCheckbox").addEventListener("change", () => {
  $("confirmBtn").disabled = !$("confirmCheckbox").checked || isPastDeadline();
});

$("confirmBtn").addEventListener("click", () => {
  if (isPastDeadline()) {
    showScreen("screenClosed");
    refreshPdfScreen();
    return;
  }
  const name = loadName();
  if (!name) {
    showScreen("screenName");
    return;
  }
  const key = todayKey();
  const log = loadLog();
  const list = log[key] || [];

  // é‡è¤‡ç™»éŒ²é˜²æ­¢ï¼ˆåŒã˜åå‰ãŒã‚ã‚Œã°è¿½åŠ ã—ãªã„ï¼‰
  if (!list.some(x => x.name === name)) {
    list.push({ name, time: nowTimeStr() });
    log[key] = list;
    saveLog(log);
  }

  alert("ç¢ºèªã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚");
  $("confirmCheckbox").checked = false;
  $("confirmBtn").disabled = true;
  refreshPdfScreen();
});

/* ===== ç®¡ç†è€…å…¥å£ ===== */
$("openAdminBtn").addEventListener("click", () => {
  const pin = prompt("ç®¡ç†è€…æš—è¨¼ç•ªå·ï¼ˆ4æ¡ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if (pin === null) return;
  if (pin.trim() !== ADMIN_PIN) {
    alert("æš—è¨¼ç•ªå·ãŒé•ã„ã¾ã™");
    return;
  }
  showScreen("screenAdmin");
  refreshAdmin();
});

/* ===== ç®¡ç†è€…æ“ä½œ ===== */
$("savePdfBtn").addEventListener("click", () => {
  const url = $("pdfUrlInput").value.trim();
  const label = $("pdfLabelInput").value.trim();
  if (!url) { alert("PDFã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  savePdf({ url, label, updatedAt: Date.now() });
  alert("PDFè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  refreshAdmin();
});

$("clearTodayBtn").addEventListener("click", () => {
  if (!confirm("ä»Šæ—¥ã®ç¢ºèªã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰")) return;
  const log = loadLog();
  delete log[todayKey()];
  saveLog(log);
  refreshAdmin();
});

$("clearAllBtn").addEventListener("click", () => {
  if (!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ç«¯æœ«ã®ã¿ï¼‰")) return;
  localStorage.removeItem(LS_LOG_KEY);
  refreshAdmin();
});

/* ===== åˆæœŸåŒ– ===== */
(function init(){
  // PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‘ã‘ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ãªã—ã§ã‚‚å‹•ããŒã€ã‚ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å¯èƒ½ï¼‰
  // â€»ä»Šå›ã¯ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ã‚’å¢—ã‚„ã•ãªã„ãŸã‚ã€SWã¯ä½¿ã„ã¾ã›ã‚“ï¼ˆå¿…è¦ãªã‚‰å¾Œã§è¿½åŠ ï¼‰
  showScreen("screenHome");
  refreshPdfScreen();
})();
</script>
</body>
</html>




