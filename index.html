<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>勤務確認</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ===== Home ===== -->
  <main id="home" class="screen active">
    <header class="topbar">
      <div class="brand">MKB 春日井</div>
      <button id="adminBtn" class="admin-btn" type="button">管理者</button>
    </header>

    <section class="center">
      <h1 class="title">勤務確認</h1>

      <button id="goBtn" class="go-btn" type="button" aria-label="勤務確認 GO">
        GO
      </button>

      <!-- バス画像：GitHubに置いた画像パスに合わせてください -->
      <div class="bus-wrap">
        <img class="bus-img" src="png/bus.png" alt="バスイラスト" />
      </div>
    </section>

    <footer class="footer">
      <div id="deadlineText" class="deadline">締切：17:00</div>
      <div id="afterMsg" class="after-msg hidden">締切後は電話連絡してください</div>
    </footer>
  </main>

  <!-- ===== Name ===== -->
  <main id="name" class="screen">
    <header class="topbar">
      <div class="brand">MKB 春日井</div>
      <button id="backFromName" class="ghost-btn" type="button">戻る</button>
    </header>

    <section class="panel">
      <h2 class="panel-title">お名前を入力してください</h2>
      <input id="nameInput" class="text-input" type="text" inputmode="text" autocomplete="name" placeholder="例：青山" />
      <button id="saveNameBtn" class="primary-btn" type="button">保存</button>
      <p class="hint">※一度保存するとこの端末に記憶されます</p>
    </section>
  </main>

  <!-- ===== PDF ===== -->
  <main id="pdf" class="screen">
    <header class="topbar">
      <div class="brand">MKB 春日井</div>
      <button id="backFromPdf" class="ghost-btn" type="button">戻る</button>
    </header>

    <section class="pdf-area">
      <!-- 表示したいPDF：/pdf/tenko.pdf をGitHubに置いてください -->
      <iframe id="pdfFrame" class="pdf-frame" src="pdf/tenko.pdf" title="点呼簿PDF"></iframe>
    </section>

    <section class="check-area">
      <div class="check-row">
        <div class="check-left">
          <div class="check-title">確認</div>
          <div id="checkStatus" class="check-status">未確認</div>
        </div>

        <button id="checkBtn" class="check-btn" type="button">確認しました</button>
      </div>

      <div class="confirmed-box">
        <div class="confirmed-title">確認した人</div>
        <div id="confirmedList" class="confirmed-list">（まだありません）</div>
      </div>

      <!-- 注意書き（小さく・下の方） -->
      <div class="note">
        ※団体名・個人情報を含むため、転用・転載は禁止。
      </div>
    </section>
  </main>

  <!-- ===== Admin ===== -->
  <main id="admin" class="screen">
    <header class="topbar">
      <div class="brand">MKB 春日井</div>
      <button id="backFromAdmin" class="ghost-btn" type="button">戻る</button>
    </header>

    <!-- PIN -->
    <section id="pinPanel" class="panel">
      <h2 class="panel-title">管理者暗証番号</h2>
      <input id="pinInput" class="text-input" type="password" inputmode="numeric" maxlength="4" placeholder="4桁" />
      <button id="pinOkBtn" class="primary-btn" type="button">開く</button>
      <p class="hint">※4桁（設定：0900）</p>
    </section>

    <!-- Admin content -->
    <section id="adminPanel" class="panel hidden">
      <h2 class="panel-title">管理者メニュー</h2>

      <div class="form-row">
        <label class="label">締切時刻</label>
        <input id="deadlineInput" class="text-input small" type="time" />
        <button id="saveDeadlineBtn" class="secondary-btn" type="button">保存</button>
      </div>

      <div class="form-row">
        <label class="label">点呼簿PDFのパス</label>
        <input id="pdfPathInput" class="text-input" type="text" placeholder="例：pdf/tenko.pdf" />
        <button id="savePdfBtn" class="secondary-btn" type="button">保存</button>
        <p class="hint">※GitHubに置いたPDFの相対パスを入れます</p>
      </div>

      <div class="form-row">
        <label class="label">本日の確認記録</label>
        <button id="clearTodayBtn" class="danger-btn" type="button">今日の確認をリセット</button>
      </div>
    </section>
  </main>

<script>
(() => {
  // ===== Settings =====
  const ADMIN_PIN = "0900";
  const LS_NAME = "mkb_name";
  const LS_DEADLINE = "mkb_deadline";    // "17:00" etc
  const LS_PDFPATH = "mkb_pdfpath";      // "pdf/tenko.pdf"
  const todayKey = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `mkb_confirm_${y}-${m}-${day}`;
  };

  const $ = (id) => document.getElementById(id);

  const screens = ["home","name","pdf","admin"];
  const show = (which) => {
    for (const s of screens) $(s).classList.toggle("active", s === which);
    window.scrollTo(0,0);
  };

  // ===== Init default =====
  const getDeadline = () => localStorage.getItem(LS_DEADLINE) || "17:00";
  const setDeadline = (v) => localStorage.setItem(LS_DEADLINE, v);

  const getPdfPath = () => localStorage.getItem(LS_PDFPATH) || "pdf/tenko.pdf";
  const setPdfPath = (v) => localStorage.setItem(LS_PDFPATH, v);

  function refreshDeadlineUI() {
    const dl = getDeadline();
    $("deadlineText").textContent = `締切：${dl}`;

    // after deadline message
    const now = new Date();
    const [hh, mm] = dl.split(":").map(Number);
    const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    const after = now.getTime() > cutoff.getTime();
    $("afterMsg").classList.toggle("hidden", !after);
    // 〆切後はチェック不可
    $("checkBtn")?.toggleAttribute("disabled", after);
  }

  function refreshPdfUI() {
    $("pdfFrame").src = getPdfPath();
  }

  // ===== Name =====
  function getName() {
    return (localStorage.getItem(LS_NAME) || "").trim();
  }
  function setName(v) {
    localStorage.setItem(LS_NAME, v.trim());
  }

  // ===== Confirm list =====
  function getConfirmers() {
    try {
      return JSON.parse(localStorage.getItem(todayKey()) || "[]");
    } catch {
      return [];
    }
  }
  function setConfirmers(arr) {
    localStorage.setItem(todayKey(), JSON.stringify(arr));
  }
  function renderConfirmers() {
    const arr = getConfirmers();
    if (!arr.length) {
      $("confirmedList").textContent = "（まだありません）";
      $("checkStatus").textContent = "未確認";
      return;
    }
    $("confirmedList").textContent = arr.join("、");
    const me = getName();
    $("checkStatus").textContent = me && arr.includes(me) ? "あなたは確認済み" : "未確認";
  }

  // ===== Buttons =====
  $("goBtn").addEventListener("click", () => {
    refreshDeadlineUI();
    const now = new Date();
    const dl = getDeadline();
    const [hh, mm] = dl.split(":").map(Number);
    const cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    const after = now.getTime() > cutoff.getTime();

    if (!getName()) {
      show("name");
      return;
    }
    if (after) {
      // 〆切後はPDFは見せる（必要なら）、チェックだけ不可
      show("pdf");
      refreshPdfUI();
      renderConfirmers();
      refreshDeadlineUI();
      return;
    }
    show("pdf");
    refreshPdfUI();
    renderConfirmers();
    refreshDeadlineUI();
  });

  $("saveNameBtn").addEventListener("click", () => {
    const v = $("nameInput").value.trim();
    if (!v) { alert("お名前を入力してください"); return; }
    setName(v);
    show("pdf");
    refreshPdfUI();
    renderConfirmers();
    refreshDeadlineUI();
  });

  $("backFromName").addEventListener("click", () => show("home"));
  $("backFromPdf").addEventListener("click", () => show("home"));

  $("checkBtn").addEventListener("click", () => {
    refreshDeadlineUI();
    if ($("checkBtn").hasAttribute("disabled")) return;

    const me = getName();
    if (!me) { show("name"); return; }
    const arr = getConfirmers();
    if (!arr.includes(me)) {
      arr.push(me);
      setConfirmers(arr);
    }
    renderConfirmers();
  });

  // ===== Admin =====
  $("adminBtn").addEventListener("click", () => {
    $("pinInput").value = "";
    $("pinPanel").classList.remove("hidden");
    $("adminPanel").classList.add("hidden");
    show("admin");
  });
  $("backFromAdmin").addEventListener("click", () => show("home"));

  $("pinOkBtn").addEventListener("click", () => {
    const v = $("pinInput").value.trim();
    if (v !== ADMIN_PIN) { alert("暗証番号が違います"); return; }
    $("pinPanel").classList.add("hidden");
    $("adminPanel").classList.remove("hidden");

    // load current settings
    $("deadlineInput").value = getDeadline();
    $("pdfPathInput").value = getPdfPath();
  });

  $("saveDeadlineBtn").addEventListener("click", () => {
    const v = $("deadlineInput").value;
    if (!v) { alert("時刻を選んでください"); return; }
    setDeadline(v);
    refreshDeadlineUI();
    alert("保存しました");
  });

  $("savePdfBtn").addEventListener("click", () => {
    const v = $("pdfPathInput").value.trim();
    if (!v) { alert("PDFのパスを入力してください"); return; }
    setPdfPath(v);
    refreshPdfUI();
    alert("保存しました");
  });

  $("clearTodayBtn").addEventListener("click", () => {
    if (!confirm("今日の確認をリセットします。よろしいですか？")) return;
    localStorage.removeItem(todayKey());
    alert("リセットしました");
  });

  // ===== start =====
  refreshDeadlineUI();
})();
</script>
</body>
</html>
