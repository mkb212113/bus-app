<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#1f66d1" />
  <title>MKB æ˜¥æ—¥äº•ï½œå‰æ—¥å‹¤å‹™ç¢ºèª</title>

  <link rel="manifest" href="manifest.json" />
  <!-- â˜… ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼šCSSã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»˜ä¸ -->
  <link rel="stylesheet" href="style.css?v=5" />
</head>
<body>
  <!-- ä¸Šéƒ¨ãƒãƒ¼ -->
  <header class="topbar">
    <div class="brand">MKB æ˜¥æ—¥äº•</div>
    <button class="adminBtn" id="openAdminBtn" type="button">ç®¡ç†è€…</button>
  </header>

  <!-- ç”»é¢1ï¼šãƒ›ãƒ¼ãƒ  -->
  <main class="screen active" id="screenHome" aria-label="ãƒ›ãƒ¼ãƒ ">
    <div class="screenInner homeCenter">
      <h1 class="title">å‰æ—¥å‹¤å‹™ç¢ºèª</h1>

      <!-- ãƒ¯ãƒ³ã‚¯ãƒƒã‚·ãƒ§ãƒ³ -->
      <button class="primaryBtn startBtn" id="goBtn" type="button">æŠ¼ã—ã¦ãã ã•ã„</button>

      <div class="deadlineWrap" aria-label="ç· åˆ‡">
        <div class="deadlineText" id="deadlineText">ç¢ºèªæ™‚é–“ã¯ 17:00 ã¾ã§</div>

        <div class="homeNotes">
          <!-- â˜… æ–‡è¨€ã‚’å¸Œæœ›ã©ãŠã‚Šã«æˆ»ã™ -->
          <div class="homeNote">â€»ç¢ºèªæ¸ˆã¿ã®æ–¹ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
          <div class="homeNote">â€»å›£ä½“åãƒ»å€‹äººæƒ…å ±ã‚’å«ã‚€ãŸã‚è»¢ç”¨ç¦æ­¢</div>
        </div>
      </div>
    </div>

    <!-- â˜… ãƒªãƒ­ãƒ¼ãƒ‰ã¯å³ä¸‹å›ºå®š -->
    <button class="reloadFab" id="reloadFab" type="button" aria-label="å†èª­ã¿è¾¼ã¿">â†»</button>
  </main>

  <!-- ç”»é¢2ï¼šåå‰å…¥åŠ› -->
  <main class="screen" id="screenName" aria-label="åå‰å…¥åŠ›">
    <div class="screenInner">
      <div class="card">
        <div class="cardTitle">åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        <div class="hint">ä¾‹ï¼šä½è—¤ å¤ªéƒ</div>

        <input class="textInput" id="nameInput" type="text" inputmode="text" autocomplete="name" placeholder="ãŠåå‰" />

        <button class="primaryBtn" id="nameConfirmBtn" type="button">ç¢ºèª</button>
        <button class="linkBtn" id="backToHomeFromName" type="button">æˆ»ã‚‹</button>
      </div>
    </div>
  </main>

  <!-- ç”»é¢3ï¼šç‚¹å‘¼ç°¿ -->
  <main class="screen" id="screenPdf" aria-label="ç‚¹å‘¼ç°¿">
    <div class="screenInner">
      <div class="dateRow">
        <span class="badgeNew" id="badgeNew">æœ€æ–°</span>
        <span class="dateText" id="todayText">2026å¹´1æœˆ1æ—¥</span>
      </div>

      <div class="pdfTitle">ç‚¹å‘¼ç°¿</div>

      <div class="pdfBox">
        <div class="pdfIcon">PDF</div>
        <div class="pdfFile" id="pdfFileName">ç‚¹å‘¼ç°¿ã‚’è¦‹ã‚‹</div>
        <a class="openBtn" id="openPdfLink" href="#" target="_blank" rel="noopener">è¦‹ã‚‹</a>
      </div>

      <!-- ãƒã‚§ãƒƒã‚¯ï¼šç¸¦é…ç½®ï¼ˆå¸Œæœ›ã©ãŠã‚Šï¼‰ -->
      <div class="checkAreaVertical">
        <div class="checkText">ç¢ºèªã—ãŸã‚‰ä¸‹ã‚’ãƒã‚§ãƒƒã‚¯</div>
        <label class="checkRowBottom" aria-label="ç¢ºèªãƒã‚§ãƒƒã‚¯">
          <input type="checkbox" id="agreeCheck" />
          <span>ç¢ºèªã—ã¾ã—ãŸ</span>
        </label>
      </div>

      <button class="linkBtn" id="openConfirmListBtn" type="button">ç¢ºèªçŠ¶æ³ï¼ˆå½“ç›´å‘ã‘ï¼‰</button>
      <button class="linkBtn" id="backToHomeFromPdf" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç”»é¢ï¼šç¢ºèªçŠ¶æ³ -->
  <main class="screen" id="screenConfirmList" aria-label="ç¢ºèªçŠ¶æ³">
    <div class="screenInner">
      <h2 class="adminTitle">æœ¬æ—¥ã®ç¢ºèªçŠ¶æ³</h2>
      <div class="confirmList" id="confirmList"></div>
      <button class="linkBtn" id="backToPdf" type="button">ç‚¹å‘¼ç°¿ã«æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç”»é¢ï¼šç· åˆ‡å¾Œ -->
  <main class="screen" id="screenClosed" aria-label="ç· åˆ‡å¾Œ">
    <div class="screenInner center">
      <div class="closedDate" id="closedDate">2026-01-01</div>
      <div class="closedTitle">ãƒãƒƒãƒˆç¢ºèªã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</div>
      <div class="closedSub">é›»è©±ã«ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
      <div class="phoneIcon">ğŸ“</div>
      <button class="linkBtn" id="backToHomeFromClosed" type="button">æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- ç®¡ç†è€…ï¼šPIN -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="modalSheet">
      <div class="modalTitle">ç®¡ç†è€…</div>
      <div class="modalHint">æš—è¨¼ç•ªå·ï¼ˆ4æ¡ï¼‰</div>
      <input class="pinInput" id="pinInput" type="password" inputmode="numeric" maxlength="4" placeholder="****" />
      <button class="primaryBtn" id="pinEnterBtn" type="button">é–‹ã</button>
      <button class="linkBtn" id="closeAdminModal" type="button">é–‰ã˜ã‚‹</button>
      <div class="errorText" id="pinError" style="display:none;">æš—è¨¼ç•ªå·ãŒé•ã„ã¾ã™ã€‚</div>
    </div>
  </div>

  <!-- ç®¡ç†è€…ç”»é¢ -->
  <main class="screen" id="screenAdmin" aria-label="ç®¡ç†è€…ç”»é¢">
    <div class="screenInner">
      <h2 class="adminTitle">ç®¡ç†è€…ç”»é¢</h2>

      <div class="adminCard">
        <div class="adminSectionTitle">ç· åˆ‡æ™‚é–“</div>
        <div class="row">
          <input class="timeInput" id="deadlineInput" type="time" />
          <button class="smallBtn" id="saveDeadlineBtn" type="button">ä¿å­˜</button>
        </div>
        <div class="adminNote">â€»ä¿å­˜ã™ã‚‹ã¨åˆæœŸç”»é¢ã®è¡¨ç¤ºã¨ç· åˆ‡åˆ¤å®šã«åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
      </div>

      <div class="adminCard">
        <div class="adminSectionTitle">ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯ï¼ˆPDF / ãƒ•ã‚©ãƒ«ãƒ€OKï¼‰</div>
        <input class="textInput" id="pdfUrlInput" type="url" placeholder="URLã‚’è²¼ã‚Šä»˜ã‘" />
        <button class="smallBtn wide" id="savePdfBtn" type="button">ä¿å­˜</button>
        <div class="adminNote">â€»Googleãƒ‰ãƒ©ã‚¤ãƒ–å…±æœ‰ãƒªãƒ³ã‚¯ç­‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
      </div>

      <div class="adminCard">
        <div class="adminSectionTitle">ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆç™»éŒ²ãƒ»å‰Šé™¤ï¼‰</div>
        <div class="row">
          <input class="textInput" id="addUserInput" type="text" placeholder="è¿½åŠ ã™ã‚‹åå‰" />
          <button class="smallBtn" id="addUserBtn" type="button">è¿½åŠ </button>
        </div>
        <div class="adminList" id="userList"></div>
        <div class="adminNote">
          â€»ãƒ¡ãƒ³ãƒãƒ¼ãŒ0äººã®é–“ã¯ã€Œèª°ã§ã‚‚ç¢ºèªã§ãã‚‹ã€é‹ç”¨ã§ã™ã€‚<br>
          â€»1äººã§ã‚‚ç™»éŒ²ã™ã‚‹ã¨ã€ç™»éŒ²åã¨è¿‘ã„åå‰ã®ã¿ç¢ºèªã§ãã¾ã™ï¼ˆèª¤å·®ã¯è¨±å®¹ï¼‰ã€‚
        </div>
      </div>

      <button class="linkBtn" id="exitAdminBtn" type="button">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
    </div>
  </main>

  <!-- â˜… JSã¯ã“ã“ã«å†…è”µï¼ˆç„¡åå¿œé˜²æ­¢ï¼‰ -->
  <script>
    const ADMIN_PIN = "0900";
    const LS_KEYS = {
      deadline: "mkb_deadline",
      pdfUrl: "mkb_pdf_url",
      users: "mkb_users",
      confirmed: "mkb_confirmed"
    };

    const screens = {
      home: document.getElementById("screenHome"),
      name: document.getElementById("screenName"),
      pdf: document.getElementById("screenPdf"),
      confirm: document.getElementById("screenConfirmList"),
      closed: document.getElementById("screenClosed"),
      admin: document.getElementById("screenAdmin"),
    };

    const deadlineText = document.getElementById("deadlineText");
    const goBtn = document.getElementById("goBtn");
    const nameInput = document.getElementById("nameInput");
    const nameConfirmBtn = document.getElementById("nameConfirmBtn");
    const openPdfLink = document.getElementById("openPdfLink");
    const pdfFileName = document.getElementById("pdfFileName");
    const todayText = document.getElementById("todayText");
    const badgeNew = document.getElementById("badgeNew");
    const agreeCheck = document.getElementById("agreeCheck");
    const openConfirmListBtn = document.getElementById("openConfirmListBtn");
    const confirmList = document.getElementById("confirmList");
    const closedDate = document.getElementById("closedDate");

    // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ«
    const adminModal = document.getElementById("adminModal");
    const openAdminBtn = document.getElementById("openAdminBtn");
    const closeAdminModal = document.getElementById("closeAdminModal");
    const pinInput = document.getElementById("pinInput");
    const pinEnterBtn = document.getElementById("pinEnterBtn");
    const pinError = document.getElementById("pinError");

    // ç®¡ç†è€…ç”»é¢
    const deadlineInput = document.getElementById("deadlineInput");
    const saveDeadlineBtn = document.getElementById("saveDeadlineBtn");
    const pdfUrlInput = document.getElementById("pdfUrlInput");
    const savePdfBtn = document.getElementById("savePdfBtn");
    const addUserInput = document.getElementById("addUserInput");
    const addUserBtn = document.getElementById("addUserBtn");
    const userList = document.getElementById("userList");
    const exitAdminBtn = document.getElementById("exitAdminBtn");

    // æˆ»ã‚‹
    document.getElementById("backToHomeFromName").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromPdf").onclick = () => showScreen("home");
    document.getElementById("backToHomeFromClosed").onclick = () => showScreen("home");
    document.getElementById("backToPdf").onclick = () => showScreen("pdf");

    // ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼‰
    document.getElementById("reloadFab").onclick = () => location.reload();

    function pad(n){ return String(n).padStart(2,"0"); }
    function todayISO(){
      const d = new Date();
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }
    function todayJP(){
      const d = new Date();
      return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
    }
    function nowHHMM(){
      const d = new Date();
      return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function getDeadline(){
      const v = localStorage.getItem(LS_KEYS.deadline);
      if (!v || !/^\d{2}:\d{2}$/.test(v)) return "17:00";
      return v;
    }
    function setDeadline(v){
      const safe = (v && /^\d{2}:\d{2}$/.test(v)) ? v : "17:00";
      localStorage.setItem(LS_KEYS.deadline, safe);
    }
    function isAfterDeadline(){
      return nowHHMM() > getDeadline();
    }

    function getUsers(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.users) || "[]"); }
      catch { return []; }
    }
    function setUsers(arr){
      localStorage.setItem(LS_KEYS.users, JSON.stringify(arr));
    }

    function getConfirmedAll(){
      try { return JSON.parse(localStorage.getItem(LS_KEYS.confirmed) || "{}"); }
      catch { return {}; }
    }
    function setConfirmedAll(obj){
      localStorage.setItem(LS_KEYS.confirmed, JSON.stringify(obj));
    }
    function addConfirmed(name){
      const iso = todayISO();
      const all = getConfirmedAll();
      all[iso] = all[iso] || [];
      if (!all[iso].includes(name)) all[iso].push(name);
      setConfirmedAll(all);
    }

    function getPdfUrl(){
      return localStorage.getItem(LS_KEYS.pdfUrl) || "#";
    }
    function setPdfUrl(url){
      localStorage.setItem(LS_KEYS.pdfUrl, url);
    }

    function showScreen(key){
      Object.values(screens).forEach(el => el.classList.remove("active"));
      screens[key].classList.add("active");
      window.scrollTo({top:0, behavior:"instant"});
    }

    // èª¤å·®è¨±å®¹ï¼ˆå‰å›ã‹ã‚‰è¸è¥²ï¼‰
    function normName(s){
      return String(s || "").normalize("NFKC").trim().replace(/[ ã€€]/g, "").toLowerCase();
    }
    function editDistance(a, b){
      a = normName(a); b = normName(b);
      const m=a.length, n=b.length;
      if (!m) return n;
      if (!n) return m;
      const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++){
        for (let j=1;j<=n;j++){
          const cost = a[i-1]===b[j-1] ? 0 : 1;
          dp[i][j] = Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);
        }
      }
      return dp[m][n];
    }
    function fuzzyMatch(input, target){
      const A = normName(input), B = normName(target);
      if (!A || !B) return false;
      if (A === B) return true;
      if (A.includes(B) || B.includes(A)) return true;
      const d = editDistance(A, B);
      const limit = Math.max(1, Math.min(2, Math.floor(Math.max(A.length,B.length)/6)));
      return d <= limit;
    }
    function isAllowedName(name){
      const users = getUsers();
      if (users.length === 0) return true;
      return users.some(u => fuzzyMatch(name, u));
    }

    function refreshHome(){
      deadlineText.textContent = `ç¢ºèªæ™‚é–“ã¯ ${getDeadline()} ã¾ã§`;
    }
    function refreshPdf(){
      todayText.textContent = todayJP();
      badgeNew.style.display = "inline-block";

      const url = getPdfUrl();
      openPdfLink.href = url === "#" ? "#" : url;
      openPdfLink.classList.toggle("disabled", url === "#");
      pdfFileName.textContent = url === "#" ? "æœªè¨­å®šï¼ˆç®¡ç†è€…ã§è¨­å®šã—ã¦ãã ã•ã„ï¼‰" : "ç‚¹å‘¼ç°¿ã‚’è¦‹ã‚‹";

      agreeCheck.checked = false;
      agreeCheck.disabled = false;
    }
    function renderConfirmList(){
      const iso = todayISO();
      const all = getConfirmedAll();
      const list = all[iso] || [];
      if (list.length === 0){
        confirmList.innerHTML = `<div class="empty">ï¼ˆæœ¬æ—¥ã®ç¢ºèªè€…ãªã—ï¼‰</div>`;
        return;
      }
      confirmList.innerHTML = list.map(n => `<div class="confirmCard">${escapeHtml(n)}</div>`).join("");
    }

    // åˆå›
    refreshHome();
    todayText.textContent = todayJP();
    closedDate.textContent = todayISO();

    // GO
    goBtn.addEventListener("click", () => {
      refreshHome();
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      showScreen("name");
      setTimeout(()=>nameInput.focus(), 50);
    });

    // åå‰ç¢ºèª
    nameConfirmBtn.addEventListener("click", () => {
      const name = (nameInput.value || "").trim();
      if (!name){ alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (!isAllowedName(name)){ alert("ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚"); return; }
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      sessionStorage.setItem("mkb_current_name", name);
      refreshPdf();
      showScreen("pdf");
    });

    // ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯æœªè¨­å®š
    openPdfLink.addEventListener("click", (e) => {
      if (openPdfLink.classList.contains("disabled") || openPdfLink.getAttribute("href")==="#"){
        e.preventDefault();
        alert("ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯ãŒæœªè¨­å®šã§ã™ã€‚ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚");
      }
    });

    // ãƒã‚§ãƒƒã‚¯ã§è¨˜éŒ²
    agreeCheck.addEventListener("change", () => {
      if (!agreeCheck.checked) return;
      if (isAfterDeadline()){
        closedDate.textContent = todayISO();
        showScreen("closed");
        return;
      }
      const name = sessionStorage.getItem("mkb_current_name") || "";
      if (!name){ showScreen("home"); return; }
      addConfirmed(name);
      agreeCheck.disabled = true;
      alert("ç¢ºèªã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚");
      showScreen("home");
      nameInput.value = "";
      sessionStorage.removeItem("mkb_current_name");
    });

    // å½“ç›´å‘ã‘
    openConfirmListBtn.addEventListener("click", () => {
      renderConfirmList();
      showScreen("confirm");
    });

    // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ€ãƒ«
    openAdminBtn.addEventListener("click", () => {
      pinInput.value = "";
      pinError.style.display = "none";
      adminModal.classList.add("show");
      adminModal.setAttribute("aria-hidden","false");
      setTimeout(()=>pinInput.focus(), 50);
    });
    closeAdminModal.addEventListener("click", () => {
      adminModal.classList.remove("show");
      adminModal.setAttribute("aria-hidden","true");
    });
    pinEnterBtn.addEventListener("click", () => {
      const pin = (pinInput.value || "").trim();
      if (pin === ADMIN_PIN){
        adminModal.classList.remove("show");
        adminModal.setAttribute("aria-hidden","true");
        openAdmin();
      } else {
        pinError.style.display = "block";
      }
    });

    function openAdmin(){
      deadlineInput.value = getDeadline();
      pdfUrlInput.value = (getPdfUrl() === "#") ? "" : getPdfUrl();
      renderUsers();
      showScreen("admin");
    }

    function renderUsers(){
      const users = getUsers();
      if (users.length === 0){
        userList.innerHTML = `<div class="empty">ï¼ˆç™»éŒ²è€…ãªã—ï¼‰</div>`;
        return;
      }
      userList.innerHTML = users.map(u => `
        <div class="listRow">
          <div class="listName">${escapeHtml(u)}</div>
          <button class="delBtn" data-name="${encodeURIComponent(u)}" type="button">å‰Šé™¤</button>
        </div>
      `).join("");
      userList.querySelectorAll(".delBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = decodeURIComponent(btn.dataset.name || "");
          const next = getUsers().filter(x => x !== name);
          setUsers(next);
          renderUsers();
        });
      });
    }

    addUserBtn.addEventListener("click", () => {
      const name = (addUserInput.value || "").trim();
      if (!name) return;
      const users = getUsers();
      if (!users.includes(name)) users.push(name);
      setUsers(users);
      addUserInput.value = "";
      renderUsers();
    });

    saveDeadlineBtn.addEventListener("click", () => {
      setDeadline(deadlineInput.value || "17:00");
      refreshHome();
      alert("ç· åˆ‡æ™‚é–“ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    savePdfBtn.addEventListener("click", () => {
      const url = (pdfUrlInput.value || "").trim();
      setPdfUrl(url ? url : "#");
      alert("ç‚¹å‘¼ç°¿ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
    });

    exitAdminBtn.addEventListener("click", () => showScreen("home"));
    document.getElementById("backToPdf").onclick = () => showScreen("pdf");

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    if ("serviceWorker" in navigator){
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
